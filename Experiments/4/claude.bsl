// Запрос для вывода всех групп справочника Номенклатура с их уровнями иерархии

// Вариант 1: Используя ИТОГИ ПО ИЕРАРХИЯ
Процедура ПолучитьГруппыСУровнямиИерархии()
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    Номенклатура.Ссылка КАК Группа,
    |    Номенклатура.Наименование КАК Наименование,
    |    Номенклатура.Родитель КАК Родитель,
    |    УРОВЕНЬВГРУППИРОВКЕ() КАК УровеньИерархии
    |ИЗ
    |    Справочник.Номенклатура КАК Номенклатура
    |ГДЕ
    |    Номенклатура.ЭтоГруппа = ИСТИНА
    |
    |ИТОГИ
    |    МАКСИМУМ(УровеньИерархии)
    |ПО
    |    Группа ИЕРАРХИЯ";
    
    // Выполнение запроса
    РезультатЗапроса = Запрос.Выполнить();
    
    // Обход результата с учетом иерархии
    ВыборкаПоГруппам = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкамСИерархией);
    
    Пока ВыборкаПоГруппам.Следующий() Цикл
        Если ВыборкаПоГруппам.ТипЗаписи() = ТипЗаписиЗапроса.ИтогПоИерархии Тогда
            // Это итоговая запись по иерархии
            Сообщить(СтрПовторить("  ", ВыборкаПоГруппам.УровеньИерархии) + 
                     "Итог: " + ВыборкаПоГруппам.Группа + 
                     " (Уровень: " + ВыборкаПоГруппам.УровеньИерархии + ")");
        Иначе
            // Это обычная запись
            Сообщить(СтрПовторить("  ", ВыборкаПоГруппам.УровеньИерархии) + 
                     ВыборкаПоГруппам.Наименование + 
                     " (Уровень: " + ВыборкаПоГруппам.УровеньИерархии + ")");
        КонецЕсли;
    КонецЦикла;
    
КонецПроцедуры

// Вариант 2: Простой запрос без итогов
Процедура ПолучитьГруппыСУровнямиПростойЗапрос()
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    Номенклатура.Ссылка КАК Группа,
    |    Номенклатура.Наименование КАК Наименование,
    |    Номенклатура.Родитель КАК Родитель,
    |    Номенклатура.Ссылка.Уровень() КАК УровеньИерархии
    |ИЗ
    |    Справочник.Номенклатура КАК Номенклатура
    |ГДЕ
    |    Номенклатура.ЭтоГруппа = ИСТИНА
    |УПОРЯДОЧИТЬ ПО
    |    УровеньИерархии,
    |    Номенклатура.Наименование ИЕРАРХИЯ";
    
    РезультатЗапроса = Запрос.Выполнить();
    ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
    
    Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
        Сообщить(СтрПовторить("  ", ВыборкаДетальныеЗаписи.УровеньИерархии) + 
                 ВыборкаДетальныеЗаписи.Наименование + 
                 " (Уровень: " + ВыборкаДетальныеЗаписи.УровеньИерархии + ")");
    КонецЦикла;
    
КонецПроцедуры

// Вариант 3: Рекурсивный запрос через общую таблицу выражения (ОТВ)
Процедура ПолучитьГруппыСУровнямиРекурсивно()
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "С ИерархияГрупп КАК (
    |    // Базовый запрос - группы первого уровня
    |    ВЫБРАТЬ
    |        Номенклатура.Ссылка КАК Группа,
    |        Номенклатура.Наименование КАК Наименование,
    |        Номенклатура.Родитель КАК Родитель,
    |        0 КАК УровеньИерархии
    |    ИЗ
    |        Справочник.Номенклатура КАК Номенклатура
    |    ГДЕ
    |        Номенклатура.ЭтоГруппа = ИСТИНА
    |        И Номенклатура.Родитель = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
    |    
    |    ОБЪЕДИНИТЬ ВСЕ
    |    
    |    // Рекурсивный запрос - подчиненные группы
    |    ВЫБРАТЬ
    |        Номенклатура.Ссылка,
    |        Номенклатура.Наименование,
    |        Номенклатура.Родитель,
    |        ИерархияГрупп.УровеньИерархии + 1
    |    ИЗ
    |        Справочник.Номенклатура КАК Номенклатура
    |            ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИерархияГрупп КАК ИерархияГрупп
    |            ПО Номенклатура.Родитель = ИерархияГрупп.Группа
    |    ГДЕ
    |        Номенклатура.ЭтоГруппа = ИСТИНА
    |)
    |ВЫБРАТЬ
    |    ИерархияГрупп.Группа,
    |    ИерархияГрупп.Наименование,
    |    ИерархияГрупп.Родитель,
    |    ИерархияГрупп.УровеньИерархии
    |ИЗ
    |    ИерархияГрупп КАК ИерархияГрупп
    |УПОРЯДОЧИТЬ ПО
    |    УровеньИерархии,
    |    Наименование";
    
    РезультатЗапроса = Запрос.Выполнить();
    ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
    
    Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
        Сообщить(СтрПовторить("  ", ВыборкаДетальныеЗаписи.УровеньИерархии) + 
                 ВыборкаДетальныеЗаписи.Наименование + 
                 " (Уровень: " + ВыборкаДетальныеЗаписи.УровеньИерархии + ")");
    КонецЦикла;
    
КонецПроцедуры
