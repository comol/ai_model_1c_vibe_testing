#Если Клиент Тогда

Процедура ЗагрузитьНоменклатуру(Команда)
    
    // Шаг 1: Выбор файла Excel
    Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
    Диалог.Фильтр = "Файлы Excel (*.xlsx;*.xls)|*.xlsx;*.xls";
    Если Не Диалог.Выбрать() Тогда
        Возврат;
    КонецЕсли;
    ПутьКФайлу = Диалог.ПолноеИмяФайла;
    
    // Шаг 2: Инициализация Excel
    ПриложениеExcel = Неопределено;
    Книга = Неопределено;
    Попытка
        ПриложениеExcel = Новый COMОбъект("Excel.Application");
        ПриложениеExcel.Visible = Ложь;
        ПриложениеExcel.DisplayAlerts = Ложь;
        
        // Шаг 3: Открытие книги
        Книга = ПриложениеExcel.Workbooks.Open(ПутьКФайлу);
        Лист = Книга.Worksheets(1);
        
        // Шаг 4: Определение колонок
        НомераКолонок = Новый Соответствие;
        НомераКолонок.Вставить("Артикул", 0);
        НомераКолонок.Вставить("Наименование", 0);
        НомераКолонок.Вставить("Описание", 0);
        НомераКолонок.Вставить("Единица измерения", 0);
        
        // Поиск колонок по заголовкам
        Для Колонка = 1 По Лист.UsedRange.Columns.Count Цикл
            Заголовок = Лист.Cells(1, Колонка).Value;
            Если НомераКолонок.Свойство(Заголовок) Тогда
                НомераКолонок[Заголовок] = Колонка;
            КонецЕсли;
        КонецЦикла;
        
        // Проверка найденных колонок
        Если НомераКолонок["Артикул"] = 0 
            Или НомераКолонок["Наименование"] = 0 
            Или НомераКолонок["Единица измерения"] = 0 Тогда
            ВызватьИсключение "Не найдены обязательные колонки";
        КонецЕсли;
        
        // Шаг 5: Обработка строк
        ВсегоСтрок = Лист.UsedRange.Rows.Count;
        Статус = Новый СтатусВозврата(ВсегоСтрок - 1);
        
        Для Строка = 2 По ВсегоСтрок Цикл
            Статус.Показать(Строка - 1, "Обработка строки " + (Строка - 1));
            
            // Чтение значений
            Артикул = Лист.Cells(Строка, НомераКолонок["Артикул"]).Value;
            Наименование = Лист.Cells(Строка, НомераКолонок["Наименование"]).Value;
            Описание = Лист.Cells(Строка, НомераКолонок["Описание"]).Value;
            ЕдИзмНаименование = Лист.Cells(Строка, НомераКолонок["Единица измерения"]).Value;
            
            // Поиск/создание элемента номенклатуры
            Найденные = Справочники.Номенклатура.НайтиПоРеквизиту("Артикул", Артикул);
            Если Найденные.Количество() > 0 Тогда
                Элемент = Найденные[0];
            Иначе
                Элемент = Справочники.Номенклатура.СоздатьЭлемент();
                Элемент.Артикул = Артикул;
            КонецЕсли;
            
            // Заполнение данных
            Элемент.Наименование = Наименование;
            Элемент.Описание = Описание;
            
            // Обработка единицы измерения
            Если ЗначениеЗаполнено(ЕдИзмНаименование) Тогда
                ЕдИзм = Справочники.ЕдиницыИзмерения.НайтиПоНаименованию(ЕдИзмНаименование);
                Если ЕдИзм = Неопределено Тогда
                    // Создаем новую единицу измерения
                    НоваяЕдИзм = Справочники.ЕдиницыИзмерения.СоздатьЭлемент();
                    НоваяЕдИзм.Наименование = ЕдИзмНаименование;
                    НоваяЕдИзм.Записать();
                    ЕдИзм = НоваяЕдИзм.Ссылка;
                КонецЕсли;
                Элемент.ЕдиницаИзмерения = ЕдИзм;
            КонецЕсли;
            
            // Запись элемента
            Элемент.Записать();
        КонецЦикла;
        
        // Шаг 6: Завершение работы
        Книга.Close(Ложь);
        ПриложениеExcel.Quit();
        Сообщить("Успешно загружено элементов: " + (ВсегоСтрок - 1));
        
    Исключение
        // Обработка ошибок
        Если Книга <> Неопределено Тогда
            Книга.Close(Ложь);
        КонецЕсли;
        Если ПриложениеExcel <> Неопределено Тогда
            ПриложениеExcel.Quit();
        КонецЕсли;
        Сообщить(ОписаниеОшибки(), СтатусСообщения.Важное);
    КонецПопытки;
    
КонецПроцедуры

#КонецЕсли