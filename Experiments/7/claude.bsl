// Модуль формы-источника с табличной частью Товары

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ КОМАНД ФОРМЫ

&НаКлиенте
Процедура ПередатьТоварыВДругуюФорму(Команда)
	
	// Формируем массив с данными табличной части
	МассивТоваров = Новый Массив;
	
	Для Каждого СтрокаТовара Из Объект.Товары Цикл
		
		СтруктураТовара = Новый Структура;
		СтруктураТовара.Вставить("Номенклатура", СтрокаТовара.Номенклатура);
		СтруктураТовара.Вставить("Количество", СтрокаТовара.Количество);
		СтруктураТовара.Вставить("Цена", СтрокаТовара.Цена);
		СтруктураТовара.Вставить("Сумма", СтрокаТовара.Сумма);
		СтруктураТовара.Вставить("СтавкаНДС", СтрокаТовара.СтавкаНДС);
		СтруктураТовара.Вставить("СуммаНДС", СтрокаТовара.СуммаНДС);
		
		МассивТоваров.Добавить(СтруктураТовара);
		
	КонецЦикла;
	
	// Создаем структуру для передачи данных
	ДанныеДляПередачи = Новый Структура;
	ДанныеДляПередачи.Вставить("Товары", МассивТоваров);
	ДанныеДляПередачи.Вставить("ФормаИсточник", ЭтаФорма.УникальныйИдентификатор);
	
	// Отправляем оповещение всем открытым формам
	Оповестить("ПередачаТоваровМеждуФормами", ДанныеДляПередачи);
	
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьФормуПолучательСТоварами(Команда)
	
	// Альтернативный вариант - передача через параметры при открытии формы
	МассивТоваров = Новый Массив;
	
	Для Каждого СтрокаТовара Из Объект.Товары Цикл
		
		СтруктураТовара = Новый Структура;
		СтруктураТовара.Вставить("Номенклатура", СтрокаТовара.Номенклатура);
		СтруктураТовара.Вставить("Количество", СтрокаТовара.Количество);
		СтруктураТовара.Вставить("Цена", СтрокаТовара.Цена);
		СтруктураТовара.Вставить("Сумма", СтрокаТовара.Сумма);
		СтруктураТовара.Вставить("СтавкаНДС", СтрокаТовара.СтавкаНДС);
		СтруктураТовара.Вставить("СуммаНДС", СтрокаТовара.СуммаНДС);
		
		МассивТоваров.Добавить(СтруктураТовара);
		
	КонецЦикла;
	
	// Параметры для открытия формы
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ПереданныеТовары", МассивТоваров);
	
	// Открываем форму получатель с параметрами
	ОткрытьФорму("ИмяФормыПолучателя", ПараметрыФормы);
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ТАБЛИЧНОЙ ЧАСТИ ТОВАРЫ

&НаКлиенте
Процедура ТоварыКоличествоПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.Товары.ТекущиеДанные;
	Если ТекущиеДанные <> Неопределено Тогда
		ТекущиеДанные.Сумма = ТекущиеДанные.Количество * ТекущиеДанные.Цена;
		РассчитатьСуммуНДС(ТекущиеДанные);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыЦенаПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.Товары.ТекущиеДанные;
	Если ТекущиеДанные <> Неопределено Тогда
		ТекущиеДанные.Сумма = ТекущиеДанные.Количество * ТекущиеДанные.Цена;
		РассчитатьСуммуНДС(ТекущиеДанные);
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

&НаКлиенте
Процедура РассчитатьСуммуНДС(СтрокаТовара)
	
	Если СтрокаТовара.СтавкаНДС = ПредопределенноеЗначение("Перечисление.СтавкиНДС.НДС20") Тогда
		СтрокаТовара.СуммаНДС = СтрокаТовара.Сумма * 0.2;
	ИначеЕсли СтрокаТовара.СтавкаНДС = ПредопределенноеЗначение("Перечисление.СтавкиНДС.НДС10") Тогда
		СтрокаТовара.СуммаНДС = СтрокаТовара.Сумма * 0.1;
	Иначе
		СтрокаТовара.СуммаНДС = 0;
	КонецЕсли;
	
КонецПроцедуры

// Модуль формы-получателя

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Проверяем, переданы ли товары через параметры формы
	Если Параметры.Свойство("ПереданныеТовары") Тогда
		ЗаполнитьТабличнуюЧастьТоварами(Параметры.ПереданныеТовары);
	КонецЕсли;
	
	// Создаем реквизит формы для хранения товаров, если его нет
	МассивДобавляемыхРеквизитов = Новый Массив;
	
	// Проверяем, есть ли уже табличная часть Товары
	Попытка
		ТестТоваров = ЭтаФорма.Товары;
	Исключение
		// Создаем табличную часть программно
		МассивДобавляемыхРеквизитов.Добавить(Новый РеквизитФормы("Товары", Новый ОписаниеТипов("ТаблицаЗначений")));
	КонецПопытки;
	
	Если МассивДобавляемыхРеквизитов.Количество() > 0 Тогда
		ИзменитьРеквизиты(МассивДобавляемыхРеквизитов);
		СоздатьКолонкиТаблицыТоваров();
		СоздатьЭлементыФормыДляТоваров();
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	// Подписываемся на оповещение о передаче товаров
	ПодключитьОбработчикОповещения("ОбработатьПолучениеТоваров", "ПередачаТоваровМеждуФормами");
	
КонецПроцедуры

&НаКлиенте
Процедура ПриЗакрытии(ЗавершениеРаботы)
	
	// Отключаем обработчик оповещения при закрытии формы
	ОтключитьОбработчикОповещения("ОбработатьПолучениеТоваров", "ПередачаТоваровМеждуФормами");
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ ОПОВЕЩЕНИЙ

&НаКлиенте
Процедура ОбработатьПолучениеТоваров(ИмяСобытия, Параметр, Источник)
	
	// Проверяем, что это наше событие и форма-источник не является текущей формой
	Если ИмяСобытия = "ПередачаТоваровМеждуФормами" 
		И ТипЗнч(Параметр) = Тип("Структура")
		И Параметр.Свойство("ФормаИсточник")
		И Параметр.ФормаИсточник <> ЭтаФорма.УникальныйИдентификатор Тогда
		
		// Получаем массив товаров
		Если Параметр.Свойство("Товары") Тогда
			ЗаполнитьТабличнуюЧастьТоварамиНаКлиенте(Параметр.Товары);
			
			// Оповещаем пользователя
			ПоказатьОповещениеПользователя(
				"Товары получены",
				,
				"Получено товаров: " + Параметр.Товары.Количество(),
				БиблиотекаКартинок.Информация32);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

&НаСервере
Процедура СоздатьКолонкиТаблицыТоваров()
	
	// Добавляем колонки в таблицу значений
	Товары = ЭтаФорма.Товары;
	Товары.Колонки.Добавить("Номенклатура", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	Товары.Колонки.Добавить("Количество", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3)));
	Товары.Колонки.Добавить("Цена", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	Товары.Колонки.Добавить("Сумма", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	Товары.Колонки.Добавить("СтавкаНДС", Новый ОписаниеТипов("ПеречислениеСсылка.СтавкиНДС"));
	Товары.Колонки.Добавить("СуммаНДС", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	
КонецПроцедуры

&НаСервере
Процедура СоздатьЭлементыФормыДляТоваров()
	
	// Создаем таблицу формы для отображения товаров
	ТаблицаФормы = Элементы.Добавить("Товары", Тип("ТаблицаФормы"));
	ТаблицаФормы.ПутьКДанным = "Товары";
	ТаблицаФормы.Отображение = ОтображениеТаблицы.Список;
	
	// Добавляем колонки
	КолонкаНоменклатура = Элементы.Добавить("ТоварыНоменклатура", Тип("ПолеФормы"), ТаблицаФормы);
	КолонкаНоменклатура.Вид = ВидПоляФормы.ПолеВвода;
	КолонкаНоменклатура.ПутьКДанным = "Товары.Номенклатура";
	КолонкаНоменклатура.Заголовок = "Номенклатура";
	
	КолонкаКоличество = Элементы.Добавить("ТоварыКоличество", Тип("ПолеФормы"), ТаблицаФормы);
	КолонкаКоличество.Вид = ВидПоляФормы.ПолеВвода;
	КолонкаКоличество.ПутьКДанным = "Товары.Количество";
	КолонкаКоличество.Заголовок = "Количество";
	
	КолонкаЦена = Элементы.Добавить("ТоварыЦена", Тип("ПолеФормы"), ТаблицаФормы);
	КолонкаЦена.Вид = ВидПоляФормы.ПолеВвода;
	КолонкаЦена.ПутьКДанным = "Товары.Цена";
	КолонкаЦена.Заголовок = "Цена";
	
	КолонкаСумма = Элементы.Добавить("ТоварыСумма", Тип("ПолеФормы"), ТаблицаФормы);
	КолонкаСумма.Вид = ВидПоляФормы.ПолеВвода;
	КолонкаСумма.ПутьКДанным = "Товары.Сумма";
	КолонкаСумма.Заголовок = "Сумма";
	
	КолонкаСтавкаНДС = Элементы.Добавить("ТоварыСтавкаНДС", Тип("ПолеФормы"), ТаблицаФормы);
	КолонкаСтавкаНДС.Вид = ВидПоляФормы.ПолеВвода;
	КолонкаСтавкаНДС.ПутьКДанным = "Товары.СтавкаНДС";
	КолонкаСтавкаНДС.Заголовок = "Ставка НДС";
	
	КолонкаСуммаНДС = Элементы.Добавить("ТоварыСуммаНДС", Тип("ПолеФормы"), ТаблицаФормы);
	КолонкаСуммаНДС.Вид = ВидПоляФормы.ПолеВвода;
	КолонкаСуммаНДС.ПутьКДанным = "Товары.СуммаНДС";
	КолонкаСуммаНДС.Заголовок = "Сумма НДС";
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьТабличнуюЧастьТоварами(МассивТоваров)
	
	// Очищаем текущие товары
	Товары.Очистить();
	
	// Заполняем новыми данными
	Для Каждого СтруктураТовара Из МассивТоваров Цикл
		
		НоваяСтрока = Товары.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтруктураТовара);
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьТабличнуюЧастьТоварамиНаКлиенте(МассивТоваров)
	
	// Вызываем серверную процедуру для заполнения
	ЗаполнитьТабличнуюЧастьТоварамиНаСервере(МассивТоваров);
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьТабличнуюЧастьТоварамиНаСервере(МассивТоваров)
	
	ЗаполнитьТабличнуюЧастьТоварами(МассивТоваров);
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ КОМАНД ФОРМЫ

&НаКлиенте
Процедура ОчиститьТовары(Команда)
	
	Товары.Очистить();
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьИтоги(Команда)
	
	ВсегоКоличество = 0;
	ВсегоСумма = 0;
	ВсегоНДС = 0;
	
	Для Каждого СтрокаТовара Из Товары Цикл
		
		ВсегоКоличество = ВсегоКоличество + СтрокаТовара.Количество;
		ВсегоСумма = ВсегоСумма + СтрокаТовара.Сумма;
		ВсегоНДС = ВсегоНДС + СтрокаТовара.СуммаНДС;
		
	КонецЦикла;
	
	// Выводим итоги (предполагается, что на форме есть соответствующие элементы)
	Сообщение = Новый СообщениеПользователю;
	Сообщение.Текст = СтрШаблон("Итого: Количество = %1, Сумма = %2, НДС = %3", 
		ВсегоКоличество, ВсегоСумма, ВсегоНДС);
	Сообщение.Сообщить();
	
КонецПроцедуры

