// Функция для загрузки курсов доллара США за последний год в таблицу значений
// Использует API ЦБ РФ для получения XML-данных
Функция ЗагрузитьКурсДоллараЗаГод() Экспорт
	
	// Определение дат: текущая и год назад
	КонечнаяДата = ТекущаяДатаСеанса();
	НачальнаяДата = ДобавитьМесяц(КонечнаяДата, -12); // Более точный расчет за год
	
	// Форматирование дат для URL
	ФорматированнаяНачальнаяДата = Формат(НачальнаяДата, "ДФ=dd/MM/yyyy");
	ФорматированнаяКонечнаяДата = Формат(КонечнаяДата, "ДФ=dd/MM/yyyy");
	
	// Формирование URL запроса
	URL = "http://www.cbr.ru/scripts/XML_dynamic.asp?date_req1=" + ФорматированнаяНачальнаяДата 
		+ "&date_req2=" + ФорматированнаяКонечнаяДата + "&VAL_NM_RQ=R01235";
	
	// Создание и выполнение HTTP-запроса с таймаутом
	HTTPЗапрос = Новый HTTPЗапрос(URL);
	HTTPСоединение = Новый HTTPСоединение("www.cbr.ru", , , , , 30);
	HTTPОтвет = HTTPСоединение.Получить(HTTPЗапрос);
	
	// Проверка успешности запроса
	Если HTTPОтвет.КодСостояния <> 200 Тогда
		ВызватьИсключение "Ошибка при получении данных: " + HTTPОтвет.КодСостояния;
	КонецЕсли;
	
	// Создание таблицы значений для курсов
	ТаблицаКурсов = Новый ТаблицаЗначений;
	ТаблицаКурсов.Колонки.Добавить("Дата", Новый ОписаниеТипов("Дата"));
	ТаблицаКурсов.Колонки.Добавить("Курс", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 4)));
	
	// Парсинг XML-ответа
	ЧтениеXML = Новый ЧтениеXML;
	ЧтениеXML.УстановитьСтроку(HTTPОтвет.ПолучитьТелоКакСтроку());
	
	Пока ЧтениеXML.Прочитать() Цикл
		Если Не (ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента И ЧтениеXML.Имя = "Record") Тогда
			Продолжить;
		КонецЕсли;
		
		ДатаКурса = Неопределено;
		ЗначениеКурса = Неопределено;
		
		// Чтение атрибута Date
		Пока ЧтениеXML.ПрочитатьАтрибут() Цикл
			Если ЧтениеXML.Имя = "Date" Тогда
				ДатаКурса = Дата(ЧтениеXML.Значение + " 00:00:00");
			КонецЕсли;
		КонецЦикла;
		
		// Чтение вложенных элементов
		Пока ЧтениеXML.Прочитать() Цикл
			Если ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента И ЧтениеXML.Имя = "Value" Тогда
				ЧтениеXML.Прочитать();
				Если ЧтениеXML.ТипУзла = ТипУзлаXML.Текст Тогда
					ЗначениеКурса = Число(СтрЗаменить(ЧтениеXML.Значение, ",", "."));
				КонецЕсли;
				ЧтениеXML.Прочитать(); // Закрытие Value
				Продолжить;
			КонецЕсли;
			
			Если ЧтениеXML.ТипУзла = ТипУзлаXML.КонецЭлемента И ЧтениеXML.Имя = "Record" Тогда
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		// Добавление строки в таблицу, если данные валидны
		Если ДатаКурса <> Неопределено И ЗначениеКурса <> Неопределено Тогда
			НоваяСтрока = ТаблицаКурсов.Добавить();
			НоваяСтрока.Дата = ДатаКурса;
			НоваяСтрока.Курс = ЗначениеКурса;
		КонецЕсли;
		
	КонецЦикла;
	
	ЧтениеXML.Закрыть();
	
	Возврат ТаблицаКурсов;
	
КонецФункции
