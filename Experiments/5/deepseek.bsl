Процедура ЗагрузитьКурсыДоллараЗаГод(ТаблицаКурсов) Экспорт

    // Определяем период: последний год
    КонечнаяДата = ТекущаяДата();
    НачальнаяДата = КонечнаяДата - 365; // ровно год назад

    // Код валюты: доллар США
    КодВалюты = "R01235";

    // Формируем SOAP-запрос
    ТелоЗапроса = 
    "<?xml version=""1.0"" encoding=""utf-8""?>" + Символы.ПС +
    "<soap:Envelope xmlns:xsi=""http://www.w3.org/2001/XMLSchema-instance"" xmlns:xsd=""http://www.w3.org/2001/XMLSchema"" xmlns:soap=""http://schemas.xmlsoap.org/soap/envelope/"">" + Символы.ПС +
    "  <soap:Body>" + Символы.ПС +
    "    <GetCursDynamic xmlns=""http://web.cbr.ru/"">" + Символы.ПС +
    "      <FromDate>" + Формат(НачальнаяДата, "ДФ=yyyy-MM-dd") + "</FromDate>" + Символы.ПС +
    "      <ToDate>" + Формат(КонечнаяДата, "ДФ=yyyy-MM-dd") + "</ToDate>" + Символы.ПС +
    "      <ValutaCode>" + КодВалюты + "</ValutaCode>" + Символы.ПС +
    "    </GetCursDynamic>" + Символы.ПС +
    "  </soap:Body>" + Символы.ПС +
    "</soap:Envelope>";

    // Создаем HTTP-запрос
    Запрос = Новый HTTPЗапрос();
    Запрос.АдресРесурса = "https://www.cbr.ru/DailyInfoWebServ/DailyInfo.asmx";
    Запрос.УстановитьТелоИзСтроки(ТелоЗапроса, "text/xml; charset=utf-8");
    Запрос.Заголовки.Вставить("SOAPAction", "http://web.cbr.ru/GetCursDynamic");

    // Создаем HTTP-соединение
    Соединение = Новый HTTPСоединение("www.cbr.ru", 443, "", "", Новый ЗащищенноеСоединениеOpenSSL());

    // Отправляем запрос
    Ответ = Соединение.ОтправитьДляОбработки(Запрос);
    Если Ответ.КодСостояния <> 200 Тогда
        ВызватьИсключение "Ошибка HTTP: " + Ответ.КодСостояния;
    КонецЕсли;

    // Разбираем ответ
    ТелоОтвета = Ответ.ПолучитьТелоКакСтроку();
    // Загружаем XML
    XMLДокумент = Новый XMLДокумент();
    XMLДокумент.Прочитать(ТелоОтвета);

    // Ищем корневой элемент
    КорневойЭлемент = XMLДокумент.ДокументныйЭлемент;
    // Пространство имен SOAP
    ПространствоИмен = Новый Соответствие();
    ПространствоИмен["soap"] = "http://schemas.xmlsoap.org/soap/envelope/";
    ПространствоИмен["m"] = "http://web.cbr.ru/";

    // Получаем элемент Body
    Тело = КорневойЭлемент.НайтиПространствоИмен("soap:Body");
    Если Тело = Неопределено Тогда
        ВызватьИсключение "Не удалось найти тело SOAP-ответа";
    КонецЕсли;

    // Получаем элемент GetCursDynamicResponse
    ОтветМетода = Тело.НайтиПространствоИмен("m:GetCursDynamicResponse");
    Если ОтветМетода = Неопределено Тогда
        ВызватьИсключение "Не удалось найти ответ метода GetCursDynamic";
    КонецЕсли;

    // Получаем элемент GetCursDynamicResult
    Результат = ОтветМетода.НайтиПространствоИмен("m:GetCursDynamicResult");
    Если Результат = Неопределено Тогда
        ВызватьИсключение "Не удалось найти результат метода";
    КонецЕсли;

    // Теперь в Результат лежит элемент, содержащий данные в формате XML
    // Согласно документации, это строка с XML-документом, поэтому нам нужно ее разобрать еще раз
    ВнутреннийXML = Новый XMLДокумент();
    ВнутреннийXML.Прочитать(Результат.ТекстовоеСодержимое);

    // Теперь ищем элементы ValuteCursDynamic
    СписокКурсов = ВнутреннийXML.ДокументныйЭлемент.НайтиПространствоИмен("ValuteCursDynamic");
    Если СписокКурсов = Неопределено Тогда
        ВызватьИсключение "Не удалось найти список курсов";
    КонецЕсли;

    // Подготовим таблицу значений
    ТаблицаКурсов.Очистить();
    ТаблицаКурсов.Колонки.Добавить("Дата", Новый ОписаниеТипов("Дата"));
    ТаблицаКурсов.Колонки.Добавить("Курс", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 4)));

    // Обходим все элементы ValuteCursDynamic
    Для Каждого УзелКурс Из СписокКурсов.Элементы Цикл
        Если УзелКурс.Имя <> "ValuteCursDynamic" Тогда
            Продолжить;
        КонецЕсли;

        // Ищем дочерние элементы: CursDate и Vcurs
        ДатаКотировки = Неопределено;
        Курс = Неопределено;

        Для Каждого ДочернийУзел Из УзелКурс.Элементы Цикл
            Если ДочернийУзел.Имя = "CursDate" Тогда
                ДатаКотировки = Дата(ДочернийУзел.ТекстовоеСодержимое);
            ИначеЕсли ДочернийУзел.Имя = "Vcurs" Тогда
                Курс = Число(ДочернийУзел.ТекстовоеСодержимое);
            КонецЕсли;
        КонецЦикла;

        Если ДатаКотировки <> Неопределено И Курс <> Неопределено Тогда
            СтрокаТаблицы = ТаблицаКурсов.Добавить();
            СтрокаТаблицы.Дата = ДатаКотировки;
            СтрокаТаблицы.Курс = Курс;
        КонецЕсли;
    КонецЦикла;

КонецПроцедуры