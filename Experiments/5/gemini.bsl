// Модуль содержит служебные функции для загрузки курсов валют с сайта ЦБ РФ.
//

&Область СлужебныйИнтерфейс

// Функция отправляет GET-запрос к API ЦБ РФ и возвращает тело ответа в виде строки XML.
//
// Параметры:
//  ДатаКурса - Дата - дата, на которую необходимо получить курс.
//
// Возвращаемое значение:
//  Строка - тело ответа в формате XML.
//  Неопределено - в случае ошибки.
//
Функция ПолучитьXMLКурсовВалют(ДатаКурса)

	// Константы
	ИмяСервера = "www.cbr.ru";
	ПортСервера = 443;
	Таймаут = 60;
	КодУспехаHTTP = 200;

	// Сформируем строку ресурса для запроса к API ЦБ РФ.
	ДатаДляЗапроса = Формат(ДатаКурса, "ДФ=dd/MM/yyyy");
	АдресРесурса = "/scripts/XML_daily.asp?date_req=" + ДатаДляЗапроса;

	Попытка

		// Установим защищенное соединение для протокола https.
		ЗащищенноеСоединение = Новый ЗащищенноеСоединениеOpenSSL();
		Соединение = Новый HTTPСоединение(ИмяСервера, ПортСервера, , , , Таймаут, ЗащищенноеСоединение);
		
		// Выполним GET-запрос.
		Запрос = Новый HTTPЗапрос(АдресРесурса);
		Ответ = Соединение.Получить(Запрос);

		Если Ответ.КодСостояния = КодУспехаHTTP Тогда

			// Если запрос успешен, читаем тело ответа.
			Возврат Ответ.ПолучитьТелоКакСтроку("UTF-8");

		Иначе

			Возврат Неопределено;

		КонецЕсли;

	Исключение
		// В случае ошибки возвращаем Неопределено.
		Возврат Неопределено;
	КонецПопытки;

КонецФункции

// Функция разбирает XML-строку и ищет в ней курс доллара США.
//
// Параметры:
//  XMLСтрока - Строка - строка с XML-данными.
//
// Возвращаемое значение:
//  Число - курс доллара.
//  Неопределено - если курс не найден или произошла ошибка.
//
Функция РазобратьXMLИНайтиКурсДоллара(XMLСтрока)

	// Константы
	КодДоллара = "R01235";
	ИмяУзлаВалюта = "Valute";
	ИмяАтрибутаID = "ID";
	ИмяУзлаНоминал = "Nominal";
	ИмяУзлаКурс = "Value";

	Если НЕ ЗначениеЗаполнено(XMLСтрока) Тогда
		Возврат Неопределено;
	КонецЕсли;

	// Создадим и настроим объект для чтения XML.
	ЧтениеXML = Новый ЧтениеXML;
	ЧтениеXML.УстановитьСтроку(XMLСтрока);

	// Используем DOM для парсинга, т.к. структура документа простая и известна.
	ПостроительDOM = Новый ПостроительDOM;
	ДокументDOM = ПостроительDOM.Прочитать(ЧтениеXML);

	// Ищем узел с нужной валютой по идентификатору.
	Для Каждого ВалютаDOM Из ДокументDOM.ПолучитьЭлементыПоИмени(ИмяУзлаВалюта) Цикл
		
		Если ВалютаDOM.ПолучитьАтрибут(ИмяАтрибутаID) = КодДоллара Тогда

			// Валюта найдена, получим её номинал и курс.
			Номинал = 0;
			Курс    = 0;

			Для Каждого Узел Из ВалютаDOM.ДочерниеУзлы Цикл
				
				Если Узел.ИмяУзла = ИмяУзлаНоминал Тогда
					Номинал = Число(Узел.ПервыйДочерний.ЗначениеУзла);
				ИначеЕсли Узел.ИмяУзла = ИмяУзлаКурс Тогда
					// Заменяем запятую на точку для корректного преобразования в число.
					Курс = Число(СтрЗаменить(Узел.ПервыйДочерний.ЗначениеУзла, ",", "."));
				КонецЕсли;
				
			КонецЦикла;

			Если Номинал > 0 Тогда
				Возврат Курс / Номинал;
			Иначе
				Возврат Неопределено;
			КонецЕсли;

		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Неопределено;

КонецФункции

&КонецОбласти

// Функция загружает курс доллара США за последний год на каждый день.
//
// Возвращаемое значение:
//  ТаблицаЗначений - таблица с колонками:
//    * Дата (Дата) - дата курса.
//    * Курс (Число) - курс доллара на указанную дату.
//
Функция ЗагрузитьКурсДоллараЗаГод() Экспорт

	// Константы
	ТочностьКурса = 4;
	ДлинаЧислаКурса = 10;
	КоличествоМесяцевВГоде = -12;

	// Создадим таблицу для хранения результата.
	ТаблицаКурсов = Новый ТаблицаЗначений;
	ТаблицаКурсов.Колонки.Добавить("Дата", Новый ОписаниеТипов("Дата"));
	КвалификаторыЧисла = Новый КвалификаторыЧисла(ДлинаЧислаКурса, ТочностьКурса);
	ТаблицаКурсов.Колонки.Добавить("Курс", Новый ОписаниеТипов("Число", КвалификаторыЧисла));

	// Определим период загрузки.
	КонецПериода = НачалоДня(ТекущаяДатаСеанса());
	НачалоПериода = ДобавитьМесяц(КонецПериода, КоличествоМесяцевВГоде);

	ТекущаяДатаПериода = НачалоПериода;

	// В цикле по дням получаем курс.
	Пока ТекущаяДатаПериода <= КонецПериода Цикл

		XMLСтрока = ПолучитьXMLКурсовВалют(ТекущаяДатаПериода);
		КурсДоллара = РазобратьXMLИНайтиКурсДоллара(XMLСтрока);

		Если КурсДоллара <> Неопределено Тогда

			// Добавляем полученные данные в результирующую таблицу.
			НоваяСтрока = ТаблицаКурсов.Добавить();
			НоваяСтрока.Дата = ТекущаяДатаПериода;
			НоваяСтрока.Курс = КурсДоллара;

		КонецЕсли;
		
		// Переходим к следующему дню.
		ТекущаяДатаПериода = ДобавитьКДате(ТекущаяДатаПериода, "ДЕНЬ", 1);

	КонецЦикла;

	Возврат ТаблицаКурсов;

КонецФункции