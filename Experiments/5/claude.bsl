////////////////////////////////////////////////////////////////////////////////
// Модуль для работы с курсами валют ЦБ РФ через XML API
// 
// Использует открытое API ЦБ РФ для получения динамики курсов валют
// Документация: https://www.cbr.ru/development/sxml/
////////////////////////////////////////////////////////////////////////////////

// Получает курсы доллара США за указанный период в таблицу значений
//
// Параметры:
//  ДатаНачала - Дата - начальная дата периода
//  ДатаОкончания - Дата - конечная дата периода  
//
// Возвращаемое значение:
//  ТаблицаЗначений - таблица с колонками:
//    * Дата - Дата - дата курса
//    * Курс - Число - курс доллара на указанную дату
//    * Номинал - Число - номинал валюты
//
Функция ПолучитьКурсыДоллараЗаПериод(ДатаНачала, ДатаОкончания) Экспорт
	
	// Код доллара США в системе ЦБ РФ
	КодВалютыUSD = "R01235";
	
	// Создаем таблицу для результатов
	ТаблицаКурсов = Новый ТаблицаЗначений;
	ТаблицаКурсов.Колонки.Добавить("Дата", Новый ОписаниеТипов("Дата"));
	ТаблицаКурсов.Колонки.Добавить("Курс", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 4)));
	ТаблицаКурсов.Колонки.Добавить("Номинал", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(10, 0)));
	
	// Формируем URL запроса к API ЦБ РФ
	БазовыйURL = "https://www.cbr.ru/scripts/XML_dynamic.asp";
	
	// Форматируем даты в нужном формате (дд/мм/гггг)
	СтрокаДатаНачала = Формат(ДатаНачала, "ДФ=dd/MM/yyyy");
	СтрокаДатаОкончания = Формат(ДатаОкончания, "ДФ=dd/MM/yyyy");
	
	// Формируем полный URL с параметрами (не используется, но оставлен для понимания)
	
	// Выполняем HTTP-запрос
	Попытка
		
		HTTPСоединение = Новый HTTPСоединение("www.cbr.ru", , , , , 10, Новый ЗащищенноеСоединениеOpenSSL());
		
		// Формируем путь запроса с параметрами
		ПутьЗапроса = "/scripts/XML_dynamic.asp?date_req1=" + СтрокаДатаНачала 
			+ "&date_req2=" + СтрокаДатаОкончания 
			+ "&VAL_NM_RQ=" + КодВалютыUSD;
		
		HTTPЗапрос = Новый HTTPЗапрос(ПутьЗапроса);
		HTTPЗапрос.Заголовки.Вставить("User-Agent", "1C:Enterprise/8.3");
		
		HTTPОтвет = HTTPСоединение.Получить(HTTPЗапрос);
		
		Если HTTPОтвет.КодСостояния = 200 Тогда
			
			// Получаем тело ответа
			ТелоОтвета = HTTPОтвет.ПолучитьТелоКакСтроку("UTF-8");
			
			// Парсим XML
			ЧтениеXML = Новый ЧтениеXML;
			ЧтениеXML.УстановитьСтроку(ТелоОтвета);
			
			// Читаем XML документ
			Пока ЧтениеXML.Прочитать() Цикл
				
				Если ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента И ЧтениеXML.Имя = "Record" Тогда
					
					// Читаем атрибуты записи
					ДатаКурса = Неопределено;
					
					Пока ЧтениеXML.ПрочитатьАтрибут() Цикл
						Если ЧтениеXML.Имя = "Date" Тогда
							// Преобразуем дату из формата ДД.ММ.ГГГГ
							СтрокаДаты = ЧтениеXML.Значение;
							ДатаКурса = ПреобразоватьДатуИзСтроки(СтрокаДаты);
						КонецЕсли;
					КонецЦикла;
					
					// Читаем вложенные элементы
					Номинал = 1;
					Курс = 0;
					
					Пока ЧтениеXML.Прочитать() Цикл
						
						Если ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
							
							ИмяЭлемента = ЧтениеXML.Имя;
							ЧтениеXML.Прочитать();
							
							Если ЧтениеXML.ТипУзла = ТипУзлаXML.Текст Тогда
								
								Если ИмяЭлемента = "Nominal" Тогда
									Номинал = Число(ЧтениеXML.Значение);
								ИначеЕсли ИмяЭлемента = "Value" Тогда
									// Заменяем запятую на точку для корректного преобразования
									СтрокаКурса = СтрЗаменить(ЧтениеXML.Значение, ",", ".");
									Курс = Число(СтрокаКурса);
								КонецЕсли;
								
							КонецЕсли;
							
						ИначеЕсли ЧтениеXML.ТипУзла = ТипУзлаXML.КонецЭлемента И ЧтениеXML.Имя = "Record" Тогда
							Прервать;
						КонецЕсли;
						
					КонецЦикла;
					
					// Добавляем запись в таблицу
					Если ДатаКурса <> Неопределено И Курс > 0 Тогда
						НоваяСтрока = ТаблицаКурсов.Добавить();
						НоваяСтрока.Дата = ДатаКурса;
						НоваяСтрока.Курс = Курс;
						НоваяСтрока.Номинал = Номинал;
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЦикла;
			
			ЧтениеXML.Закрыть();
			
		Иначе
			ВызватьИсключение "Ошибка получения данных с сервера ЦБ РФ. Код ответа: " + HTTPОтвет.КодСостояния;
		КонецЕсли;
		
	Исключение
		ВызватьИсключение "Ошибка при обращении к API ЦБ РФ: " + ОписаниеОшибки();
	КонецПопытки;
	
	// Сортируем таблицу по дате
	ТаблицаКурсов.Сортировать("Дата");
	
	Возврат ТаблицаКурсов;
	
КонецФункции

// Получает курсы доллара США за последний год
//
// Возвращаемое значение:
//  ТаблицаЗначений - таблица с курсами за последний год
//
Функция ПолучитьКурсыДоллараЗаПоследнийГод() Экспорт
	
	// Определяем период - последний год от текущей даты
	ДатаОкончания = ТекущаяДатаСеанса();
	ДатаНачала = ДобавитьМесяц(ДатаОкончания, -12);
	
	Возврат ПолучитьКурсыДоллараЗаПериод(ДатаНачала, ДатаОкончания);
	
КонецФункции

// Преобразует строку даты формата ДД.ММ.ГГГГ в дату
//
// Параметры:
//  СтрокаДаты - Строка - дата в формате ДД.ММ.ГГГГ
//
// Возвращаемое значение:
//  Дата - преобразованная дата
//
Функция ПреобразоватьДатуИзСтроки(СтрокаДаты)
	
	// Разбираем строку даты
	Части = СтрРазделить(СтрокаДаты, ".");
	
	Если Части.Количество() = 3 Тогда
		День = Число(Части[0]);
		Месяц = Число(Части[1]);
		Год = Число(Части[2]);
		Возврат Дата(Год, Месяц, День);
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции
