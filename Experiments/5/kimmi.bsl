// Загрузка курса доллара США за последний год с сайта ЦБ РФ
// Используется XML API: https://www.cbr.ru/development/sxml/

Функция ЗагрузитьКурсДоллараЗаГод()
    
    // Создание таблицы значений для хранения курсов
    ТаблицаКурсов = Новый ТаблицаЗначений;
    ТаблицаКурсов.Колонки.Добавить("Дата", Новый ОписаниеТипов("Дата"));
    ТаблицаКурсов.Колонки.Добавить("Курс", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 4)));
    
    // Определение дат начала и окончания периода
    ДатаОкончания = ТекущаяДата();
    ДатаНачала = НачалоДня(ДобавитьМесяц(ДатаОкончания, -12));
    
    // Формирование URL для запроса к API ЦБ РФ
    // Используем ежедневные курсы валют (XML_daily.asp)
    БазовыйURL = "https://www.cbr.ru/scripts/XML_daily.asp";
    
    // Перебираем каждый день в заданном периоде
    ТекущаяДата = ДатаНачала;
    
    Пока ТекущаяДата <= ДатаОкончания Цикл
        
        // Формирование URL с параметрами даты
        URL = БазовыйURL + "?date_req=" + Формат(ТекущаяДата, "ДФ=dd/MM/yyyy");
        
        // Выполнение HTTP-запроса
        Попытка
            Соединение = Новый HTTPСоединение("www.cbr.ru", 443,,,,, Новый ЗащищенноеСоединениеOpenSSL);
            HTTPЗапрос = Новый HTTPЗапрос("GET");
            HTTPОтвет = Соединение.Получить(HTTPЗапрос(URL));
            
            Если HTTPОтвет.КодСостояния = 200 Тогда
                
                // Получение XML данных
                ДанныеXML = HTTPОтвет.ПолучитьТелоКакСтроку();
                
                // Разбор XML для получения курса доллара
                ЧтениеXML = Новый ЧтениеXML;
                ЧтениеXML.УстановитьСтроку(ДанныеXML);
                
                ПарсерXML = Новый ПарсерXML;
                ДокументXML = ПарсерXML.Разобрать(ЧтениеXML);
                
                // Поиск валюты с кодом USD (R01235)
                УзелValCurs = ДокументXML.КорневойУзел;
                
                Для Каждого УзелValute Из УзелValCurs.ДочерниеУзлы() Цикл
                    
                    Если УзелValute.Имя = "Valute" Тогда
                        
                        ID = "";
                        Курс = 0;
                        Номинал = 1;
                        
                        Для Каждого Узел Из УзелValute.ДочерниеУзлы() Цикл
                            
                            Если Узел.Имя = "CharCode" И Узел.ТекстовоеСодержимое = "USD" Тогда
                                // Найден доллар, получаем значения
                                Для Каждого ВнутреннийУзел Из УзелValute.ДочерниеУзлы() Цикл
                                    
                                    Если ВнутреннийУзел.Имя = "Value" Тогда
                                        Курс = Число(СтрЗаменить(ВнутреннийУзел.ТекстовоеСодержимое, ",", "."));
                                    ИначеЕсли ВнутреннийУзел.Имя = "Nominal" Тогда
                                        Номинал = Число(ВнутреннийУзел.ТекстовоеСодержимое);
                                    КонецЕсли;
                                    
                                КонецЦикла;
                                
                                // Добавление записи в таблицу
                                НоваяСтрока = ТаблицаКурсов.Добавить();
                                НоваяСтрока.Дата = ТекущаяДата;
                                НоваяСтрока.Курс = Курс / Номинал;
                                
                                Прервать;
                                
                            КонецЕсли;
                            
                        КонецЦикла;
                        
                    КонецЕсли;
                    
                КонецЦикла;
                
            Иначе
                // Обработка ошибки HTTP-запроса
                Сообщить("Ошибка при получении данных для даты " + Формат(ТекущаяДата, "ДФ=dd.MM.yyyy") + ": " + HTTPОтвет.КодСостояния);
            КонецЕсли;
            
        Исключение
            // Обработка исключений при выполнении запроса
            Сообщить("Ошибка при выполнении запроса для даты " + Формат(ТекущаяДата, "ДФ=dd.MM.yyyy") + ": " + ОписаниеОшибки());
        КонецПопытки;
        
        // Переход к следующему дню
        ТекущаяДата = ТекущаяДата + 1;
        
    КонецЦикла;
    
    // Сортировка таблицы по дате
    ТаблицаКурсов.Сортировать("Дата");
    
    // Вывод результатов
    Сообщить("Загружено курсов доллара: " + ТаблицаКурсов.Количество());
    
    Для Каждого Строка Из ТаблицаКурсов Цикл
        Сообщить(Формат(Строка.Дата, "ДФ=dd.MM.yyyy") + ": " + Строка.Курс);
    КонецЦикла;
    
    Возврат ТаблицаКурсов;
    
КонецФункции

// Вызов функции для загрузки курсов
КурсыДоллара = ЗагрузитьКурсДоллараЗаГод();
