// Модуль демонстрации FIFO-списания из ТаблицаЗначений

Функция СоздатьТаблицуПоступленийСДанными() Экспорт
	// Создает и заполняет таблицу значений поступлений с колонками: Номенклатура, Количество, Сумма, Дата.
	// Возвращает ТаблицаЗначений, отсортированную по Номенклатуре и Дате (возрастание) для корректного FIFO.

	Поступления = Новый ТаблицаЗначений;
	Поступления.Колонки.Добавить("Номенклатура");
	Поступления.Колонки.Добавить("Количество");
	Поступления.Колонки.Добавить("Сумма");
	Поступления.Колонки.Добавить("Дата");

	Стр = Поступления.Добавить();
	Стр.Номенклатура = "Товар А";
	Стр.Количество = 10;
	Стр.Сумма = 1000; // цена 100
	Стр.Дата = Дата(2024, 1, 10);

	Стр = Поступления.Добавить();
	Стр.Номенклатура = "Товар А";
	Стр.Количество = 5;
	Стр.Сумма = 625; // цена 125
	Стр.Дата = Дата(2024, 2, 5);

	Стр = Поступления.Добавить();
	Стр.Номенклатура = "Товар А";
	Стр.Количество = 8;
	Стр.Сумма = 1200; // цена 150
	Стр.Дата = Дата(2024, 3, 1);

	Стр = Поступления.Добавить();
	Стр.Номенклатура = "Товар B";
	Стр.Количество = 7;
	Стр.Сумма = 560; // цена 80
	Стр.Дата = Дата(2024, 1, 20);

	Стр = Поступления.Добавить();
	Стр.Номенклатура = "Товар B";
	Стр.Количество = 4;
	Стр.Сумма = 360; // цена 90
	Стр.Дата = Дата(2024, 2, 15);

	Поступления.Сортировать("Номенклатура, Дата Возр");

	Возврат Поступления;
КонецФункции

Функция СписатьFIFO(Поступления, Номенклатура, Количество) Экспорт
	// Выполняет списание по методу FIFO.
	// Вход: Таблица поступлений, номенклатура, количество.
	// Выход: ТаблицаЗначений с разрезом партий: Номенклатура, ДатаПартии, Количество, Цена, Сумма.

	Результат = Новый ТаблицаЗначений;
	Результат.Колонки.Добавить("Номенклатура");
	Результат.Колонки.Добавить("ДатаПартии");
	Результат.Колонки.Добавить("Количество");
	Результат.Колонки.Добавить("Цена");
	Результат.Колонки.Добавить("Сумма");

	Осталось = Количество;

	Для Каждого СтрП Из Поступления Цикл
		Если Осталось <= 0 Тогда

			Прервать;
		КонецЕсли;

		Если СтрП.Номенклатура <> Номенклатура Тогда

			Продолжить;
		КонецЕсли;

		Если СтрП.Количество <= 0 Тогда

			Продолжить;
		КонецЕсли;

		Если СтрП.Количество < Осталось Тогда
			КоличествоКСписанию = СтрП.Количество;
		Иначе
			КоличествоКСписанию = Осталось;
		КонецЕсли;

		Если СтрП.Количество = 0 Тогда
			ЦенаПартии = 0;
		Иначе
			ЦенаПартии = СтрП.Сумма / СтрП.Количество;
		КонецЕсли;

		СуммаСписания = Окр(КоличествоКСписанию * ЦенаПартии, 2);

		СтрР = Результат.Добавить();
		СтрР.Номенклатура = Номенклатура;
		СтрР.ДатаПартии = СтрП.Дата;
		СтрР.Количество = КоличествоКСписанию;
		СтрР.Цена = ЦенаПартии;
		СтрР.Сумма = СуммаСписания;

		СтрП.Количество = СтрП.Количество - КоличествоКСписанию;
		СтрП.Сумма = Окр(СтрП.Сумма - СуммаСписания, 2);

		Осталось = Осталось - КоличествоКСписанию;
	КонецЦикла;

	Возврат Результат;
КонецФункции

Функция ДемонстрацияFIFO() Экспорт
	// Возвращает структуру с исходной таблицей и результатами двух списаний для демонстрации.

	Поступления = СоздатьТаблицуПоступленийСДанными();

	РезультатА = СписатьFIFO(Поступления, "Товар А", 12);
	РезультатB = СписатьFIFO(Поступления, "Товар B", 8);

	Возврат Новый Структура("Поступления,РезультатА,РезультатB", Поступления, РезультатА, РезультатB);
КонецФункции