// Демонстрация списания товаров по методу FIFO
// Автор: AI Assistant
// Дата: Текущая дата

// Процедура создания и заполнения таблицы значений тестовыми данными
Функция СоздатьТаблицуОстатков() Экспорт
	
	// Создаем таблицу значений
	ТаблицаОстатков = Новый ТаблицаЗначений;
	
	// Добавляем колонки
	ТаблицаОстатков.Колонки.Добавить("Номенклатура", Новый ОписаниеТипов("Строка", , , , Новый КвалификаторыСтроки(150)));
	ТаблицаОстатков.Колонки.Добавить("Количество", Новый ОписаниеТипов("Число", , , Новый КвалификаторыЧисла(15, 3)));
	ТаблицаОстатков.Колонки.Добавить("Сумма", Новый ОписаниеТипов("Число", , , Новый КвалификаторыЧисла(15, 2)));
	ТаблицаОстатков.Колонки.Добавить("Дата", Новый ОписаниеТипов("Дата"));
	
	// Заполняем тестовыми данными
	
	// Товар 1: Ноутбук - несколько поступлений
	НоваяСтрока = ТаблицаОстатков.Добавить();
	НоваяСтрока.Номенклатура = "Ноутбук HP ProBook";
	НоваяСтрока.Количество = 5;
	НоваяСтрока.Сумма = 250000;
	НоваяСтрока.Дата = Дата(2024, 1, 10);
	
	НоваяСтрока = ТаблицаОстатков.Добавить();
	НоваяСтрока.Номенклатура = "Ноутбук HP ProBook";
	НоваяСтрока.Количество = 3;
	НоваяСтрока.Сумма = 156000;
	НоваяСтрока.Дата = Дата(2024, 2, 15);
	
	НоваяСтрока = ТаблицаОстатков.Добавить();
	НоваяСтрока.Номенклатура = "Ноутбук HP ProBook";
	НоваяСтрока.Количество = 7;
	НоваяСтрока.Сумма = 371000;
	НоваяСтрока.Дата = Дата(2024, 3, 20);
	
	// Товар 2: Монитор - несколько поступлений
	НоваяСтрока = ТаблицаОстатков.Добавить();
	НоваяСтрока.Номенклатура = "Монитор Dell 24";
	НоваяСтрока.Количество = 10;
	НоваяСтрока.Сумма = 150000;
	НоваяСтрока.Дата = Дата(2024, 1, 5);
	
	НоваяСтрока = ТаблицаОстатков.Добавить();
	НоваяСтрока.Номенклатура = "Монитор Dell 24";
	НоваяСтрока.Количество = 8;
	НоваяСтрока.Сумма = 128000;
	НоваяСтрока.Дата = Дата(2024, 2, 28);
	
	// Товар 3: Клавиатура
	НоваяСтрока = ТаблицаОстатков.Добавить();
	НоваяСтрока.Номенклатура = "Клавиатура Logitech";
	НоваяСтрока.Количество = 20;
	НоваяСтрока.Сумма = 40000;
	НоваяСтрока.Дата = Дата(2024, 1, 15);
	
	НоваяСтрока = ТаблицаОстатков.Добавить();
	НоваяСтрока.Номенклатура = "Клавиатура Logitech";
	НоваяСтрока.Количество = 15;
	НоваяСтрока.Сумма = 31500;
	НоваяСтрока.Дата = Дата(2024, 3, 10);
	
	// Сортируем по дате для правильной работы FIFO
	ТаблицаОстатков.Сортировать("Дата");
	
	Возврат ТаблицаОстатков;
	
КонецФункции

// Функция списания товара по методу FIFO
// Параметры:
//   ТаблицаОстатков - ТаблицаЗначений - таблица с остатками товаров
//   Номенклатура - Строка - наименование товара для списания
//   КоличествоКСписанию - Число - количество к списанию
// Возвращаемое значение:
//   Структура - результат списания с полями:
//     Успешно - Булево - успешность операции
//     Списано - Число - фактически списанное количество
//     СуммаСписания - Число - общая сумма списания
//     ДеталиСписания - ТаблицаЗначений - детализация списания по партиям
//     Сообщение - Строка - сообщение об ошибке или результате
Функция СписатьПоFIFO(ТаблицаОстатков, Номенклатура, КоличествоКСписанию) Экспорт
	
	// Инициализация результата
	Результат = Новый Структура;
	Результат.Вставить("Успешно", Ложь);
	Результат.Вставить("Списано", 0);
	Результат.Вставить("СуммаСписания", 0);
	Результат.Вставить("ДеталиСписания", Новый ТаблицаЗначений);
	Результат.Вставить("Сообщение", "");
	
	// Создаем таблицу для детализации списания
	Результат.ДеталиСписания.Колонки.Добавить("Дата", Новый ОписаниеТипов("Дата"));
	Результат.ДеталиСписания.Колонки.Добавить("Количество", Новый ОписаниеТипов("Число"));
	Результат.ДеталиСписания.Колонки.Добавить("Сумма", Новый ОписаниеТипов("Число"));
	Результат.ДеталиСписания.Колонки.Добавить("ЦенаЗаЕдиницу", Новый ОписаниеТипов("Число"));
	
	// Проверка входных параметров
	Если КоличествоКСписанию <= 0 Тогда
		Результат.Сообщение = "Количество к списанию должно быть больше нуля";
		Возврат Результат;
	КонецЕсли;
	
	// Копируем таблицу для работы
	РабочаяТаблица = ТаблицаОстатков.Скопировать();
	
	// Отбираем только нужную номенклатуру и сортируем по дате (FIFO)
	РабочаяТаблица = РабочаяТаблица.Скопировать(Новый Структура("Номенклатура", Номенклатура));
	РабочаяТаблица.Сортировать("Дата");
	
	// Проверяем наличие товара
	Если РабочаяТаблица.Количество() = 0 Тогда
		Результат.Сообщение = СтрШаблон("Товар '%1' не найден на остатках", Номенклатура);
		Возврат Результат;
	КонецЕсли;
	
	// Считаем общее количество на остатках
	ОбщееКоличество = 0;
	Для Каждого Строка Из РабочаяТаблица Цикл
		ОбщееКоличество = ОбщееКоличество + Строка.Количество;
	КонецЦикла;
	
	// Проверяем достаточность остатков
	Если ОбщееКоличество < КоличествоКСписанию Тогда
		Результат.Сообщение = СтрШаблон("Недостаточно товара '%1' на остатках. Требуется: %2, доступно: %3", 
			Номенклатура, КоличествоКСписанию, ОбщееКоличество);
		Возврат Результат;
	КонецЕсли;
	
	// Списание по методу FIFO
	ОсталосьСписать = КоличествоКСписанию;
	
	Для Каждого СтрокаОстатка Из РабочаяТаблица Цикл
		
		Если ОсталосьСписать = 0 Тогда
			Прервать;
		КонецЕсли;
		
		// Определяем количество к списанию из текущей партии
		КоличествоИзПартии = Мин(СтрокаОстатка.Количество, ОсталосьСписать);
		
		Если КоличествоИзПартии > 0 Тогда
			
			// Рассчитываем цену за единицу и сумму списания
			ЦенаЗаЕдиницу = ?(СтрокаОстатка.Количество = 0, 0, СтрокаОстатка.Сумма / СтрокаОстатка.Количество);
			СуммаСписанияПартии = Окр(ЦенаЗаЕдиницу * КоличествоИзПартии, 2);
			
			// Добавляем в детализацию
			ДетальСписания = Результат.ДеталиСписания.Добавить();
			ДетальСписания.Дата = СтрокаОстатка.Дата;
			ДетальСписания.Количество = КоличествоИзПартии;
			ДетальСписания.Сумма = СуммаСписанияПартии;
			ДетальСписания.ЦенаЗаЕдиницу = ЦенаЗаЕдиницу;
			
			// Обновляем остатки в исходной таблице
			НайденныеСтроки = ТаблицаОстатков.НайтиСтроки(Новый Структура("Номенклатура,Дата", 
				СтрокаОстатка.Номенклатура, СтрокаОстатка.Дата));
			
			Если НайденныеСтроки.Количество() > 0 Тогда
				НайденныеСтроки[0].Количество = НайденныеСтроки[0].Количество - КоличествоИзПартии;
				НайденныеСтроки[0].Сумма = НайденныеСтроки[0].Сумма - СуммаСписанияПартии;
			КонецЕсли;
			
			// Обновляем счетчики
			Результат.Списано = Результат.Списано + КоличествоИзПартии;
			Результат.СуммаСписания = Результат.СуммаСписания + СуммаСписанияПартии;
			ОсталосьСписать = ОсталосьСписать - КоличествоИзПартии;
			
		КонецЕсли;
		
	КонецЦикла;
	
	// Удаляем строки с нулевыми остатками
	Индекс = ТаблицаОстатков.Количество() - 1;
	Пока Индекс >= 0 Цикл
		Если ТаблицаОстатков[Индекс].Количество = 0 Тогда
			ТаблицаОстатков.Удалить(Индекс);
		КонецЕсли;
		Индекс = Индекс - 1;
	КонецЦикла;
	
	Результат.Успешно = Истина;
	Результат.Сообщение = СтрШаблон("Успешно списано %1 единиц товара '%2' на сумму %3", 
		Результат.Списано, Номенклатура, Результат.СуммаСписания);
	
	Возврат Результат;
	
КонецФункции

// Процедура демонстрации работы списания по FIFO
Процедура ДемонстрацияFIFO() Экспорт
	
	// Создаем и заполняем таблицу остатков
	ТаблицаОстатков = СоздатьТаблицуОстатков();
	
	Сообщить("=== ДЕМОНСТРАЦИЯ СПИСАНИЯ ПО МЕТОДУ FIFO ===");
	Сообщить("");
	Сообщить("Исходные остатки товаров:");
	ВывестиТаблицуОстатков(ТаблицаОстатков);
	
	// Пример 1: Списание ноутбуков
	Сообщить("");
	Сообщить("--- Пример 1: Списание 6 ноутбуков ---");
	РезультатСписания = СписатьПоFIFO(ТаблицаОстатков, "Ноутбук HP ProBook", 6);
	ВывестиРезультатСписания(РезультатСписания);
	
	Сообщить("");
	Сообщить("Остатки после списания:");
	ВывестиТаблицуОстатков(ТаблицаОстатков);
	
	// Пример 2: Списание мониторов
	Сообщить("");
	Сообщить("--- Пример 2: Списание 12 мониторов ---");
	РезультатСписания = СписатьПоFIFO(ТаблицаОстатков, "Монитор Dell 24", 12);
	ВывестиРезультатСписания(РезультатСписания);
	
	Сообщить("");
	Сообщить("Остатки после списания:");
	ВывестиТаблицуОстатков(ТаблицаОстатков);
	
	// Пример 3: Попытка списать больше, чем есть
	Сообщить("");
	Сообщить("--- Пример 3: Попытка списать 50 клавиатур (больше, чем есть) ---");
	РезультатСписания = СписатьПоFIFO(ТаблицаОстатков, "Клавиатура Logitech", 50);
	ВывестиРезультатСписания(РезультатСписания);
	
	// Пример 4: Списание оставшихся клавиатур
	Сообщить("");
	Сообщить("--- Пример 4: Списание 30 клавиатур ---");
	РезультатСписания = СписатьПоFIFO(ТаблицаОстатков, "Клавиатура Logitech", 30);
	ВывестиРезультатСписания(РезультатСписания);
	
	Сообщить("");
	Сообщить("Финальные остатки:");
	ВывестиТаблицуОстатков(ТаблицаОстатков);
	
КонецПроцедуры

// Вспомогательная процедура для вывода таблицы остатков
Процедура ВывестиТаблицуОстатков(ТаблицаОстатков)
	
	Если ТаблицаОстатков.Количество() = 0 Тогда
		Сообщить("Таблица остатков пуста");
		Возврат;
	КонецЕсли;
	
	Сообщить(СтрПовторить("-", 80));
	Сообщить("| Дата       | Номенклатура          | Количество | Сумма      | Цена за ед. |");
	Сообщить(СтрПовторить("-", 80));
	
	Для Каждого Строка Из ТаблицаОстатков Цикл
		ЦенаЗаЕдиницу = ?(Строка.Количество = 0, 0, Окр(Строка.Сумма / Строка.Количество, 2));
		СтрокаТаблицы = СтрШаблон("| %1 | %2 | %3 | %4 | %5 |",
			СокрЛП(Формат(Строка.Дата, "ДФ=dd.MM.yyyy")),
			Лев(Строка.Номенклатура + СтрПовторить(" ", 21), 21),
			Прав(СтрПовторить(" ", 10) + Формат(Строка.Количество, "ЧЦ=10; ЧДЦ=3; ЧН=0"), 10),
			Прав(СтрПовторить(" ", 10) + Формат(Строка.Сумма, "ЧЦ=10; ЧДЦ=2; ЧН=0"), 10),
			Прав(СтрПовторить(" ", 11) + Формат(ЦенаЗаЕдиницу, "ЧЦ=10; ЧДЦ=2; ЧН=0"), 11));
		Сообщить(СтрокаТаблицы);
	КонецЦикла;
	
	Сообщить(СтрПовторить("-", 80));
	
КонецПроцедуры

// Вспомогательная процедура для вывода результата списания
Процедура ВывестиРезультатСписания(РезультатСписания)
	
	Сообщить("Результат: " + РезультатСписания.Сообщение);
	
	Если РезультатСписания.Успешно И РезультатСписания.ДеталиСписания.Количество() > 0 Тогда
		Сообщить("");
		Сообщить("Детализация списания по партиям:");
		Сообщить(СтрПовторить("-", 70));
		Сообщить("| Дата партии | Количество | Цена за ед. | Сумма      |");
		Сообщить(СтрПовторить("-", 70));
		
		Для Каждого Деталь Из РезультатСписания.ДеталиСписания Цикл
			СтрокаДетали = СтрШаблон("| %1  | %2 | %3 | %4 |",
				СокрЛП(Формат(Деталь.Дата, "ДФ=dd.MM.yyyy")),
				Прав(СтрПовторить(" ", 10) + Формат(Деталь.Количество, "ЧЦ=10; ЧДЦ=3; ЧН=0"), 10),
				Прав(СтрПовторить(" ", 11) + Формат(Деталь.ЦенаЗаЕдиницу, "ЧЦ=10; ЧДЦ=2; ЧН=0"), 11),
				Прав(СтрПовторить(" ", 10) + Формат(Деталь.Сумма, "ЧЦ=10; ЧДЦ=2; ЧН=0"), 10));
			Сообщить(СтрокаДетали);
		КонецЦикла;
		
		Сообщить(СтрПовторить("-", 70));
		Сообщить(СтрШаблон("Итого списано: %1, на сумму: %2",
			Формат(РезультатСписания.Списано, "ЧЦ=10; ЧДЦ=3; ЧН=0"),
			Формат(РезультатСписания.СуммаСписания, "ЧЦ=10; ЧДЦ=2; ЧН=0")));
	КонецЕсли;
	
КонецПроцедуры

// Точка входа для запуска демонстрации
ДемонстрацияFIFO();
