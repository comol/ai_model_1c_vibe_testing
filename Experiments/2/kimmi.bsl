// Создание таблицы значений с тестовыми данными
ТаблицаТоваров = Новый ТаблицаЗначений;
ТаблицаТоваров.Колонки.Добавить("Номенклатура", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
ТаблицаТоваров.Колонки.Добавить("Количество", Новый ОписаниеТипов("Число"));
ТаблицаТоваров.Колонки.Добавить("Сумма", Новый ОписаниеТипов("Число"));
ТаблицаТоваров.Колонки.Добавить("Дата", Новый ОписаниеТипов("Дата"));

// Заполнение тестовыми данными
// Создаем несколько записей для одной номенклатуры с разными датами и ценами
Номенклатура1 = Справочники.Номенклатура.СоздатьЭлемент();
Номенклатура1.Наименование = "Товар А";
Номенклатура1.Записать();

НоваяЗапись = ТаблицаТоваров.Добавить();
НоваяЗапись.Номенклатура = Номенклатура1;
НоваяЗапись.Количество = 100;
НоваяЗапись.Сумма = 10000; // Цена 100 за единицу
НоваяЗапись.Дата = '01.01.2024';

НоваяЗапись = ТаблицаТоваров.Добавить();
НоваяЗапись.Номенклатура = Номенклатура1;
НоваяЗапись.Количество = 150;
НоваяЗапись.Сумма = 18000; // Цена 120 за единицу
НоваяЗапись.Дата = '15.01.2024';

НоваяЗапись = ТаблицаТоваров.Добавить();
НоваяЗапись.Номенклатура = Номенклатура1;
НоваяЗапись.Количество = 200;
НоваяЗапись.Сумма = 26000; // Цена 130 за единицу
НоваяЗапись.Дата = '01.02.2024';

// Процедура списания товара по методу FIFO
Процедура СписатьТоварПоFIFO(ТаблицаОстатков, НоменклатураДляСписания, КоличествоДляСписания)
    
    // Сортируем таблицу по дате (самые старые партии первые)
    ТаблицаОстатков.Сортировать("Дата Возр");
    
    ОсталосьСписать = КоличествоДляСписания;
    СуммаСписания = 0;
    
    // Создаем таблицу для записей на списание
    ТаблицаСписания = Новый ТаблицаЗначений;
    ТаблицаСписания.Колонки.Добавить("Номенклатура");
    ТаблицаСписания.Колонки.Добавить("Количество");
    ТаблицаСписания.Колонки.Добавить("Сумма");
    ТаблицаСписания.Колонки.Добавить("Дата");
    
    // Проходим по всем записям для данной номенклатуры
    Для Каждого СтрокаОстатка Из ТаблицаОстатков Цикл
        
        // Проверяем только нужную номенклатуру
        Если СтрокаОстатка.Номенклатура <> НоменклатураДляСписания Тогда
            Продолжить;
        КонецЕсли;
        
        // Если есть остаток по данной партии
        Если СтрокаОстатка.Количество > 0 Тогда
            
            // Определяем сколько можно списать из этой партии
            КоличествоИзПартии = Мин(ОсталосьСписать, СтрокаОстатка.Количество);
            
            // Рассчитываем стоимость списываемого количества
            ЦенаЗаЕдиницу = СтрокаОстатка.Сумма / СтрокаОстатка.Количество;
            СуммаИзПартии = КоличествоИзПартии * ЦенаЗаЕдиницу;
            
            // Создаем запись о списании
            НоваяЗаписьСписания = ТаблицаСписания.Добавить();
            НоваяЗаписьСписания.Номенклатура = СтрокаОстатка.Номенклатура;
            НоваяЗаписьСписания.Количество = КоличествоИзПартии;
            НоваяЗаписьСписания.Сумма = СуммаИзПартии;
            НоваяЗаписьСписания.Дата = СтрокаОстатка.Дата;
            
            // Уменьшаем остаток в таблице
            СтрокаОстатка.Количество = СтрокаОстатка.Количество - КоличествоИзПартии;
            СтрокаОстатка.Сумма = СтрокаОстатка.Сумма - СуммаИзПартии;
            
            // Уменьшаем количество для списания
            ОсталосьСписать = ОсталосьСписать - КоличествоИзПартии;
            СуммаСписания = СуммаСписания + СуммаИзПартии;
            
            // Если все списали - выходим из цикла
            Если ОсталосьСписать <= 0 Тогда
                Прервать;
            КонецЕсли;
            
        КонецЕсли;
        
    КонецЦикла;
    
    // Проверяем достаточность остатков
    Если ОсталосьСписать > 0 Тогда
        Сообщить("Внимание! Недостаточно товара на складе. Осталось несписанным: " + ОсталосьСписать);
    Иначе
        Сообщить("Списание завершено успешно. Списано: " + КоличествоДляСписания + 
                ", на сумму: " + СуммаСписания);
    КонецЕсли;
    
    Возврат ТаблицаСписания;
    
КонецПроцедуры

// Демонстрация работы алгоритма
Сообщить("=== Исходные остатки ===");
Для Каждого Строка Из ТаблицаТоваров Цикл
    Сообщить(Строка.Номенклатура.Наименование + ": " + Строка.Количество + 
            " шт, сумма: " + Строка.Сумма + ", дата: " + Формат(Строка.Дата, "ДФ=dd.MM.yyyy"));
КонецЦикла;

// Списываем 200 единиц товара А
Сообщить("=== Списание 200 единиц товара А по FIFO ===");
ТаблицаСписанного = СписатьТоварПоFIFO(ТаблицаТоваров, Номенклатура1, 200);

Сообщить("=== Списанные партии ===");
Для Каждого Строка Из ТаблицаСписанного Цикл
    Сообщить(Строка.Номенклатура.Наименование + ": " + Строка.Количество + 
            " шт, сумма: " + Строка.Сумма + ", дата: " + Формат(Строка.Дата, "ДФ=dd.MM.yyyy"));
КонецЦикла;

Сообщить("=== Остатки после списания ===");
Для Каждого Строка Из ТаблицаТоваров