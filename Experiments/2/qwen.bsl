// ======================================================================================
// Модуль для демонстрации списания товаров по методу FIFO (First In, First Out)
// ======================================================================================

// Создание таблицы значений с тестовыми данными и демонстрация списания по FIFO
Процедура ДемонстрацияСписанияFIFO()
	
	// Создаем таблицу значений для хранения остатков товаров
	ТаблицаТоваров = Новый ТаблицаЗначений;
	ТаблицаТоваров.Колонки.Добавить("Номенклатура", Новый ОписаниеТипов("Строка"));
	ТаблицаТоваров.Колонки.Добавить("Количество", Новый ОписаниеТипов("Число"));
	ТаблицаТоваров.Колонки.Добавить("Сумма", Новый ОписаниеТипов("Число"));
	ТаблицаТоваров.Колонки.Добавить("Дата", Новый ОписаниеТипов("Дата"));
	
	// Заполняем тестовыми данными (партии товаров с разными датами поступления)
	// Партия 1: 10 единиц, дата 01.01.2024, сумма 1000
	СтрокаТаблицы = ТаблицаТоваров.Добавить();
	СтрокаТаблицы.Номенклатура = "Товар1";
	СтрокаТаблицы.Количество = 10;
	СтрокаТаблицы.Сумма = 1000;
	СтрокаТаблицы.Дата = '20240101';
	
	// Партия 2: 5 единиц, дата 15.01.2024, сумма 600
	СтрокаТаблицы = ТаблицаТоваров.Добавить();
	СтрокаТаблицы.Номенклатура = "Товар1";
	СтрокаТаблицы.Количество = 5;
	СтрокаТаблицы.Сумма = 600;
	СтрокаТаблицы.Дата = '20240115';
	
	// Партия 3: 8 единиц, дата 20.01.2024, сумма 960
	СтрокаТаблицы = ТаблицаТоваров.Добавить();
	СтрокаТаблицы.Номенклатура = "Товар1";
	СтрокаТаблицы.Количество = 8;
	СтрокаТаблицы.Сумма = 960;
	СтрокаТаблицы.Дата = '20240120';
	
	// Добавляем другой товар для демонстрации
	// Партия 1: 15 единиц, дата 10.01.2024, сумма 3000
	СтрокаТаблицы = ТаблицаТоваров.Добавить();
	СтрокаТаблицы.Номенклатура = "Товар2";
	СтрокаТаблицы.Количество = 15;
	СтрокаТаблицы.Сумма = 3000;
	СтрокаТаблицы.Дата = '20240110';
	
	// Партия 2: 7 единиц, дата 25.01.2024, сумма 1540
	СтрокаТаблицы = ТаблицаТоваров.Добавить();
	СтрокаТаблицы.Номенклатура = "Товар2";
	СтрокаТаблицы.Количество = 7;
	СтрокаТаблицы.Сумма = 1540;
	СтрокаТаблицы.Дата = '20240125';
	
	// Выводим исходную таблицу товаров
	Сообщить("=== ИСХОДНАЯ ТАБЛИЦА ТОВАРОВ ===");
	Для Каждого СтрокаТаблицы Из ТаблицаТоваров Цикл
		Сообщить("Номенклатура: " + СтрокаТаблицы.Номенклатура + 
				", Количество: " + СтрокаТаблицы.Количество + 
				", Сумма: " + СтрокаТаблицы.Сумма + 
				", Дата: " + Формат(СтрокаТаблицы.Дата, "ДФ=dd.MM.yyyy"));
	КонецЦикла;
	Сообщить("");
	
	// Демонстрируем списание по FIFO для Товар1 (12 единиц)
	Сообщить("=== СПИСАНИЕ 12 ЕДИНИЦ ТОВАР1 ПО FIFO ===");
	СписатьТоварПоФИФО(ТаблицаТоваров, "Товар1", 12);
	
	Сообщить("");
	Сообщить("=== ОСТАТОК ПОСЛЕ СПИСАНИЯ ТОВАР1 ===");
	Для Каждого СтрокаТаблицы Из ТаблицаТоваров Цикл
		Если СтрокаТаблицы.Количество > 0 И СтрокаТаблицы.Номенклатура = "Товар1" Тогда
			Сообщить("Номенклатура: " + СтрокаТаблицы.Номенклатура + 
					", Количество: " + СтрокаТаблицы.Количество + 
					", Сумма: " + СтрокаТаблицы.Сумма + 
					", Дата: " + Формат(СтрокаТаблицы.Дата, "ДФ=dd.MM.yyyy"));
		КонецЕсли;
	КонецЦикла;
	
	Сообщить("");
	Сообщить("=== СПИСАНИЕ 5 ЕДИНИЦ ТОВАР2 ПО FIFO ===");
	СписатьТоварПоФИФО(ТаблицаТоваров, "Товар2", 5);
	
	Сообщить("");
	Сообщить("=== ФИНАЛЬНЫЙ ОСТАТОК ===");
	Для Каждого СтрокаТаблицы Из ТаблицаТоваров Цикл
		Если СтрокаТаблицы.Количество > 0 Тогда
			Сообщить("Номенклатура: " + СтрокаТаблицы.Номенклатура + 
					", Количество: " + СтрокаТаблицы.Количество + 
					", Сумма: " + СтрокаТаблицы.Сумма + 
					", Дата: " + Формат(СтрокаТаблицы.Дата, "ДФ=dd.MM.yyyy"));
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// ======================================================================================
// Процедура списания товара по методу FIFO (First In, First Out)
// ======================================================================================
// Параметры:
//   ТаблицаТоваров     - ТаблицаЗначений с остатками товаров
//   Номенклатура       - Строка, номенклатура для списания
//   КоличествоКСписанию - Число, количество единиц для списания
// ======================================================================================
Процедура СписатьТоварПоФИФО(ТаблицаТоваров, Номенклатура, КоличествоКСписанию)
	
	// Сортируем таблицу по дате по возрастанию для обеспечения FIFO
	// (первые поступившие товары - первые списываются)
	ТаблицаТоваров.Сортировать("Дата");
	
	// Инициализируем оставшееся количество для списания
	ОставшееСяКоличествоКСписанию = КоличествоКСписанию;
	
	Сообщить("Начинаем списание " + КоличествоКСписанию + " единиц товара " + Номенклатура);
	
	// Проходим по строкам таблицы в порядке FIFO
	Для Каждого СтрокаТаблицы Из ТаблицаТоваров Цикл
		
		// Работаем только с нужной номенклатурой и только если есть что списывать
		Если СтрокаТаблицы.Номенклатура = Номенклатура И СтрокаТаблицы.Количество > 0 Тогда
			
			// Если уже все списали, выходим из цикла
			Если ОставшееСяКоличествоКСписанию <= 0 Тогда
				Прервать;
			КонецЕсли;
			
			Сообщить("Обрабатываем партию от " + Формат(СтрокаТаблицы.Дата, "ДФ=dd.MM.yyyy") + 
					", доступно: " + СтрокаТаблицы.Количество + " единиц");
			
			// Если в текущей партии достаточно товара для полного списания
			Если СтрокаТаблицы.Количество >= ОставшееСяКоличествоКСписанию Тогда
				
				// Сохраняем исходные значения для расчета новой суммы
				СтароеКоличество = СтрокаТаблицы.Количество;
				СтараяСумма = СтрокаТаблицы.Сумма;
				
				// Списываем часть из этой строки
				СтрокаТаблицы.Количество = СтрокаТаблицы.Количество - ОставшееСяКоличествоКСписанию;
				
				// Пропорционально уменьшаем сумму (если было количество > 0)
				Если СтароеКоличество > 0 Тогда
					СтрокаТаблицы.Сумма = СтараяСумма * СтрокаТаблицы.Количество / СтароеКоличество;
				КонецЕсли;
				
				Сообщить("Списано " + ОставшееСяКоличествоКСписанию + " единиц от " + 
						Формат(СтрокаТаблицы.Дата, "ДФ=dd.MM.yyyy") + 
						", остаток в партии: " + СтрокаТаблицы.Количество);
				
				ОставшееСяКоличествоКСписанию = 0;
				
			Иначе
				// Списываем всю строку (в партии меньше, чем нужно списать)
				Сообщить("Полностью списана партия от " + 
						Формат(СтрокаТаблицы.Дата, "ДФ=dd.MM.yyyy") + 
						" в количестве " + СтрокаТаблицы.Количество);
				
				ОставшееСяКоличествоКСписанию = ОставшееСяКоличествоКСписанию - СтрокаТаблицы.Количество;
				СтрокаТаблицы.Количество = 0;
				СтрокаТаблицы.Сумма = 0;
				
				Сообщить("Осталось списать: " + ОставшееСяКоличествоКСписанию + " единиц");
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	// Если не удалось списать все запрошенное количество
	Если ОставшееСяКоличествоКСписанию > 0 Тогда
		Сообщить("ВНИМАНИЕ: Не удалось списать " + ОставшееСяКоличествоКСписанию + 
				" единиц товара " + Номенклатура + " (недостаточно остатка)");
	Иначе
		Сообщить("Списание успешно завершено");
	КонецЕсли;
	
КонецПроцедуры

// ======================================================================================
// Основная процедура для запуска демонстрации
// ======================================================================================
Процедура ОсновнаяПроцедура()
	
	Сообщить("Демонстрация работы метода FIFO для списания товаров");
	Сообщить("===================================================");
	
	// Запуск демонстрации
	ДемонстрацияСписанияFIFO();
	
	Сообщить("");
	Сообщить("===================================================");
	Сообщить("Демонстрация завершена");
	
КонецПроцедуры

// Запуск основной процедуры
ОсновнаяПроцедура();
