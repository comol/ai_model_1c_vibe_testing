// Модуль формы обработки для выгрузки и загрузки данных справочника.
// На форме должны быть две кнопки с именами Выгрузить и Загрузить,
// для которых нужно назначить одноименные команды.

&НаКлиенте
Процедура Выгрузить(Команда)
	
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Сохранение);
	Диалог.Заголовок = "Выберите файл для выгрузки";
	Диалог.Фильтр = "Файл данных (*.dat)|*.dat";
	Если Диалог.Выбрать() Тогда
		ИмяФайла = Диалог.ПолноеИмяФайла;
		ВыгрузитьНаСервере(ИмяФайла);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ВыгрузитьНаСервере(ИмяФайла)
	
	// ВАЖНО: Замените "Номенклатура" на имя вашего справочника
	ИмяСправочника = "Номенклатура";
	
	// Используем иерархическую выборку, чтобы сначала шли родители, потом дочерние элементы.
	// Это важно для корректного восстановления иерархии при загрузке.
	Выборка = Справочники[ИмяСправочника].ВыбратьИерархически();
	
	МассивОбъектов = Новый Массив;
	Пока Выборка.Следующий() Цикл
		
		// Получаем объект со всеми данными (реквизиты, табличные части).
		МассивОбъектов.Добавить(Выборка.Ссылка.ПолучитьОбъект());
		
	КонецЦикла;
	
	// Сериализуем массив объектов во внутреннем формате 1С.
	// Этот способ подходит для переноса между идентичными конфигурациями.
	СтрокаДанных = ЗначениеВСтрокуВнутр(МассивОбъектов);
	
	// Сохраняем строку в текстовый файл.
	ТекстовыйДокумент = Новый ТекстовыйДокумент;
	ТекстовыйДокумент.УстановитьТекст(СтрокаДанных);
	ТекстовыйДокумент.Записать(ИмяФайла, КодировкаТекста.UTF8);
	
КонецПроцедуры

&НаКлиенте
Процедура Загрузить(Команда)
	
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	Диалог.Заголовок = "Выберите файл для загрузки";
	Диалог.Фильтр = "Файл данных (*.dat)|*.dat";
	Если Диалог.Выбрать() Тогда
		ИмяФайла = Диалог.ПолноеИмяФайла;
		ЗагрузитьНаСервере(ИмяФайла);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьНаСервере(ИмяФайла)
	
	// Читаем данные из файла.
	ТекстовыйДокумент = Новый ТекстовыйДокумент;
	ТекстовыйДокумент.Прочитать(ИмяФайла, КодировкаТекста.UTF8);
	СтрокаДанных = ТекстовыйДокумент.ПолучитьТекст();
	
	Если НЕ ЗначениеЗаполнено(СтрокаДанных) Тогда
		Возврат;
	КонецЕсли;
	
	// Десериализуем объекты из внутреннего формата 1С.
	МассивОбъектов = ЗначениеИзСтрокиВнутр(СтрокаДанных);
	
	Для Каждого ОбъектДляЗагрузки Из МассивОбъектов Цикл
		
		// Устанавливаем флаг, что это загрузка данных.
		// Это позволяет обойти некоторые проверки и записать объект "как есть".
		ОбъектДляЗагрузки.ОбменДанными.Загрузка = Истина;
		
		// Записываем объект. 
		// Если объект с таким же внутренним идентификатором уже есть, он обновится.
		// Если нет - будет создан новый.
		Попытка
			ОбъектДляЗагрузки.Записать();
		Исключение
			// Здесь можно добавить логирование или сообщение об ошибке,
			// если какой-то объект не удалось записать.
			ЗаписьЖурналаРегистрации("ОбменДанными", УровеньЖурналаРегистрации.Ошибка, , ,
				"Не удалось загрузить объект: " + ОбъектДляЗагрузки.Ссылка + ". " + ОписаниеОшибки());
		КонецПопытки;
		
	КонецЦикла;
	
КонецПроцедуры
