// Форма-приемник данных для отображения переданных товаров
// Вторая форма для получения и отображения данных из первой формы

&НаКлиенте
Перем ПолученныеТовары;

// Инициализация формы при открытии
&НаКлиенте
Процедура ПриОткрытии(Отказ, СтандартнаяОбработка)
    
    // Получаем параметры из первой формы
    Если Параметры <> Неопределено И Параметры.Свойство("Товары") Тогда
        ПолученныеТовары = Параметры.Товары;
        ЗаполнитьТаблицуТоваров();
    Иначе
        ПолученныеТовары = Новый Массив;
        ПоказатьПредупреждение("Нет данных для отображения");
    КонецЕсли;
    
КонецПроцедуры

// Заполнение табличной части полученными данными
&НаКлиенте
Процедура ЗаполнитьТаблицуТоваров()
    
    // Очищаем табличную часть
    Элементы.ПолученныеТовары.Очистить();
    
    // Заполняем таблицу полученными товарами
    Для Каждого Товар Из ПолученныеТовары Цикл
        
        НоваяСтрока = Элементы.ПолученныеТовары.Добавить();
        НоваяСтрока.Номер = Товар.Номер;
        НоваяСтрока.Наименование = Товар.Наименование;
        НоваяСтрока.Количество = Товар.Количество;
        НоваяСтрока.Цена = Товар.Цена;
        НоваяСтрока.Сумма = Товар.Сумма;
        
    КонецЦикла;
    
    // Обновляем итоговую информацию
    ОбновитьИтоговуюИнформацию();
    
КонецПроцедуры

// Обновление итоговой информации
&НаКлиенте
Процедура ОбновитьИтоговуюИнформацию()
    
    ОбщееКоличество = 0;
    ОбщаяСумма = 0;
    
    Для Каждого СтрокаТаблицы Из Элементы.ПолученныеТовары Цикл
        ОбщееКоличество = ОбщееКоличество + СтрокаТаблицы.Количество;
        ОбщаяСумма = ОбщаяСумма + СтрокаТаблицы.Сумма;
    КонецЦикла;
    
    // Обновляем поля с итогами
    ОбщееКоличествоТоваров = ОбщееКоличество;
    ОбщаяСуммаТоваров = ОбщаяСумма;
    КоличествоПозиций = Элементы.ПолученныеТовары.Количество();
    
КонецПроцедуры

// Команда для обновления данных из первой формы
&НаКлиенте
Процедура ОбновитьДанные(Команда)
    
    // Закрываем текущую форму и открываем первую для выбора новых данных
    Закрыть();
    ОткрытьФорму("ФормаИсточник");
    
КонецПроцедуры

// Команда для сохранения данных в файл
&НаКлиенте
Процедура СохранитьВФайл(Команда)
    
    Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Сохранение);
    Диалог.Заголовок = "Сохранить список товаров";
    Диалог.ПолноеИмяФайла = "Товары.txt";
    
    Если Диалог.Выбрать() Тогда
        Попытка
            Запись = Новый ЗаписьТекста(Диалог.ПолноеИмяФайла);
            
            Запись.ЗаписатьСтроку("Список товаров:");
            Запись.ЗаписатьСтроку("");
            
            Для Каждого Товар Из ПолученныеТовары Цикл
                Строка = СтрШаблон("%1. %2 - %3 шт. по %4 руб. = %5 руб.", 
                    Товар.Номер, Товар.Наименование, Товар.Количество, Товар.Цена, Товар.Сумма);
                Запись.ЗаписатьСтроку(Строка);
            КонецЦикла;
            
            Запись.ЗаписатьСтроку("");
            Запись.ЗаписатьСтроку(СтрШаблон("Итого: %1 позиций, %2 единиц товара на сумму %3 руб.", 
                ПолученныеТовары.Количество(), ОбщееКоличествоТоваров, ОбщаяСуммаТоваров));
            
            Запись.Закрыть();
            
            ПоказатьИнформацию("Данные успешно сохранены в файл: " + Диалог.ПолноеИмяФайла);
            
        Исключение
            ПоказатьОшибку("Ошибка при сохранении файла: " + ОписаниеОшибки());
        КонецПопытки;
    КонецЕсли;
    
КонецПроцедуры

// Обработчик двойного клика по строке таблицы
&НаКлиенте
Процедура ПолученныеТоварыВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
    
    Если ВыбраннаяСтрока <> Неопределено Тогда
        ПоказатьИнформацию(СтрШаблон("Выбран товар: %1\nКоличество: %2\nЦена: %3\nСумма: %4", 
            ВыбраннаяСтрока.Наименование, ВыбраннаяСтрока.Количество, ВыбраннаяСтрока.Цена, ВыбраннаяСтрока.Сумма));
    КонецЕсли;
    
КонецПроцедуры
