//////////////////////////////////////////////////////////////////////////////
// ПРОГРАММНЫЙ МОДУЛЬ ФОРМЫ ЭЛЕМЕНТА СПРАВОЧНИКА НОМЕНКЛАТУРА
//
// НАЗНАЧЕНИЕ:
//   Обработка событий формы элемента справочника Номенклатура
//   Отображение и управление картинкой элемента
//
//////////////////////////////////////////////////////////////////////////////

#Область ОбработчикиСобытийФормы

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	// Обновление картинки при открытии формы
	ОбновитьКартинкуНаФорме();
	
КонецПроцедуры

&НаКлиенте
Процедура КартинкаНажатие(Элемент)
	
	// Обработка нажатия на декорацию "Картинка"
	ВыбратьИЗагрузитьКартинку();
	
КонецПроцедуры

#КонецОбласти

#Область ПроцедурыИФункцииРаботыСКартинкой

&НаКлиенте
Процедура ОбновитьКартинкуНаФорме()
	
	// Проверка наличия реквизита Картинка в объекте
	Если Объект.Свойство("Картинка") Тогда
		
		// Получение картинки из хранилища значений
		ХранилищеКартинки = Объект.Картинка;
		
		Если ХранилищеКартинки <> Неопределено Тогда
			
			Попытка
				// Извлечение картинки из хранилища
				КартинкаИзХранилища = ХранилищеКартинки.Получить();
				
				Если КартинкаИзХранилища <> Неопределено Тогда
					// Установка картинки в элемент формы
					Элементы.Картинка.Картинка = КартинкаИзХранилища;
				Иначе
					// Установка картинки по умолчанию, если хранилище пустое
					УстановитьКартинкуПоУмолчанию();
				КонецЕсли;
				
			Исключение
				// В случае ошибки извлечения картинки
				УстановитьКартинкуПоУмолчанию();
			КонецПопытки;
			
		Иначе
			// Установка картинки по умолчанию, если реквизит пустой
			УстановитьКартинкуПоУмолчанию();
		КонецЕсли;
		
	Иначе
		// Если реквизит Картинка отсутствует в объекте
		УстановитьКартинкуПоУмолчанию();
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура УстановитьКартинкуПоУмолчанию()
	
	// Установка стандартной картинки-заглушки
	Элементы.Картинка.Картинка = БиблиотекаКартинок.ПустаяКартинка;
	
КонецПроцедуры

&НаКлиенте
Процедура ВыбратьИЗагрузитьКартинку()
	
	// Настройка диалога выбора файла
	ДиалогВыбора = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	ДиалогВыбора.Заголовок = "Выберите файл с картинкой";
	ДиалогВыбора.ПолноеИмяФайла = "";
	ДиалогВыбора.ПредварительныйПросмотр = Истина;
	
	// Установка фильтра для графических файлов
	ДиалогВыбора.Фильтр = 
		"Все картинки (*.bmp;*.dib;*.rle;*.jpg;*.jpeg;*.tif;*.gif;*.png;*.ico;*.wmf;*.emf)|*.bmp;*.dib;*.rle;*.jpg;*.jpeg;*.tif;*.gif;*.png;*.ico;*.wmf;*.emf|" +
		"Формат BMP (*.bmp;*.dib;*.rle)|*.bmp;*.dib;*.rle|" +
		"Формат JPEG (*.jpg;*.jpeg)|*.jpg;*.jpeg|" +
		"Формат TIFF (*.tif)|*.tif|" +
		"Формат GIF (*.gif)|*.gif|" +
		"Формат PNG (*.png)|*.png|" +
		"Формат ICON (*.ico)|*.ico|" +
		"Формат метафайл (*.wmf;*.emf)|*.wmf;*.emf|";
	
	// Отображение диалога выбора файла
	Если ДиалогВыбора.Выбрать() Тогда
		
		// Получение полного имени выбранного файла
		ПолноеИмяФайла = ДиалогВыбора.ПолноеИмяФайла;
		
		// Загрузка картинки на сервер
		ЗагрузитьКартинкуНаСервере(ПолноеИмяФайла);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьКартинкуНаСервере(ПолноеИмяФайла)
	
	// Помещение файла во временное хранилище
	АдресВременногоХранилища = ПоместитьФайл(ПолноеИмяФайла, , Ложь, УникальныйИдентификатор);
	
	// Вызов серверной процедуры для обработки картинки
	ОбработатьКартинкуНаСервере(АдресВременногоХранилища);
	
КонецПроцедуры

&НаСервере
Процедура ОбработатьКартинкуНаСервере(Знач АдресВременногоХранилища)
	
	Попытка
		
		// Получение файла из временного хранилища
		ДвоичныеДанныеКартинки = ПолучитьИзВременногоХранилища(АдресВременногоХранилища);
		
		Если ДвоичныеДанныеКартинки <> Неопределено Тогда
			
			// Создание объекта картинки из двоичных данных
			НоваяКартинка = Новый Картинка(ДвоичныеДанныеКартинки);
			
			// Помещение картинки в хранилище значений
			НовоеХранилище = Новый ХранилищеЗначения(НоваяКартинка);
			
			// Сохранение хранилища в реквизит объекта
			Объект.Картинка = НовоеХранилище;
			
			// Запись объекта для сохранения изменений
			Объект.Записать();
			
			// Обновление картинки на форме
			ОбновитьКартинкуНаФормеНаСервере();
			
		КонецЕсли;
		
	Исключение
		// В случае ошибки загрузки картинки
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		ЗаписьЖурналаРегистрации("РаботаСКартинкамиНоменклатуры", УровеньЖурналаРегистрации.Ошибка, , 
			"Ошибка при загрузке картинки: " + ОписаниеОшибки(), ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
	КонецПопытки;
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьКартинкуНаФормеНаСервере()
	
	// Обновление картинки на форме после серверных изменений
	ЗначенияРеквизитов = Новый Структура;
	ЗначенияРеквизитов.Вставить("Картинка", Объект.Картинка);
	
	// Передача обновленных значений на клиент
	СвойстваФормы = Новый Структура;
	СвойстваФормы.Вставить("Объект", ЗначенияРеквизитов);
	
	ИзменитьСвойстваФормы(СвойстваФормы);
	
КонецПроцедуры

#КонецОбласти

//////////////////////////////////////////////////////////////////////////////
// КОНЕЦ ПРОГРАММНОГО МОДУЛЯ
//////////////////////////////////////////////////////////////////////////////
