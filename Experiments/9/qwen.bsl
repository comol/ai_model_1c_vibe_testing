// Модуль формы элемента справочника Номенклатура
// Функционал отображения и редактирования картинки

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	// Отображаем картинку при открытии формы
	ОтобразитьКартинку();
	
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Инициализация формы при создании на сервере
	
КонецПроцедуры

&НаКлиенте
Процедура ОтобразитьКартинку()
	
	// Отображаем картинку из реквизита в декорации
	Если Не ПустаяСтрока(Объект.Картинка) Тогда
		// Преобразуем строку в двоичные данные
		ДвоичныеДанные = ПолучитьДвоичныеДанныеИзСтроки(Объект.Картинка);
		// Устанавливаем картинку в декорацию
		Элементы.Картинка.Картинка = ДвоичныеДанные;
	Иначе
		// Если картинки нет, очищаем декорацию
		Элементы.Картинка.Картинка = Неопределено;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура КартинкаНажатие(Элемент)
	
	// Обработчик нажатия на картинку - открываем диалог выбора файла
	ДиалогВыбораФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	ДиалогВыбораФайла.Заголовок = "Выберите файл с картинкой";
	ДиалогВыбораФайла.Фильтр = "Файлы изображений (*.jpg, *.jpeg, *.png, *.bmp, *.gif)|*.jpg;*.jpeg;*.png;*.bmp;*.gif|Все файлы (*.*)|*.*";
	
	Если ДиалогВыбораФайла.Выбрать() Тогда
		// Получаем выбранный файл
		ВыбранныйФайл = ДиалогВыбораФайла.ВыбранныеФайлы[0];
		
		// Читаем содержимое файла
		ДвоичныеДанные = ПолучитьДвоичныеДанныеИзФайла(ВыбранныйФайл.ПолноеИмя);
		
		// Преобразуем двоичные данные в строку для хранения в реквизите
		СтрокаДанных = ПолучитьСтрокуИзДвоичныхДанных(ДвоичныеДанные);
		
		// Сохраняем строку в реквизит
		Объект.Картинка = СтрокаДанных;
		
		// Отображаем новую картинку
		ОтобразитьКартинку();
		
		// Сохраняем объект
		Объект.Записать();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ПолучитьДвоичныеДанныеИзСтроки(Строка)
	
	// Преобразование строки в двоичные данные
	Если ПустаяСтрока(Строка) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Попытка
		// Используем Base64 для преобразования
		Возврат Base64Значение(Строка);
	Исключение
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции

&НаСервере
Функция ПолучитьСтрокуИзДвоичныхДанных(ДвоичныеДанные)
	
	// Преобразование двоичных данных в строку
	Если ДвоичныеДанные = Неопределено Тогда
		Возврат "";
	КонецЕсли;
	
	Попытка
		// Используем Base64 для преобразования
		Возврат Base64Строка(ДвоичныеДанные);
	Исключение
		Возврат "";
	КонецПопытки;
	
КонецФункции

&НаСервере
Функция ПолучитьДвоичныеДанныеИзФайла(ПутьКФайлу)
	
	// Чтение двоичных данных из файла
	Если Не СуществуетФайла(ПутьКФайлу) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Попытка
		Возврат ПолучитьДвоичныеДанныеИзФайла(ПутьКФайлу);
	Исключение
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции
