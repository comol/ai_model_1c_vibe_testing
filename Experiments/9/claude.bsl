////////////////////////////////////////////////////////////////////////////////
// Модуль формы элемента справочника Номенклатура
// Обработка картинки элемента номенклатуры
////////////////////////////////////////////////////////////////////////////////

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Установка картинки из хранилища значений при открытии формы
	Если ЗначениеЗаполнено(Объект.Картинка) Тогда
		
		// Получаем картинку из хранилища значений
		КартинкаИзХранилища = Объект.Картинка.Получить();
		
		// Если в хранилище действительно картинка, устанавливаем её
		Если ТипЗнч(КартинкаИзХранилища) = Тип("Картинка") Тогда
			ЭтаФорма.Элементы.Картинка.Картинка = КартинкаИзХранилища;
		КонецЕсли;
		
	КонецЕсли;
	
	// Настройка элемента декорации для возможности нажатия
	ЭтаФорма.Элементы.Картинка.Гиперссылка = Истина;
	
КонецПроцедуры

&НаКлиенте
Процедура КартинкаНажатие(Элемент)
	
	// Создание диалога выбора файла для картинок
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	Диалог.Заголовок = "Выберите файл с изображением";
	Диалог.ПредварительныйПросмотр = Истина;
	
	// Установка фильтра для изображений
	Диалог.Фильтр = "Все картинки (*.bmp;*.dib;*.rle;*.jpg;*.jpeg;*.tif;*.gif;*.png;*.ico;*.wmf;*.emf)|"
		+ "*.bmp;*.dib;*.rle;*.jpg;*.jpeg;*.tif;*.gif;*.png;*.ico;*.wmf;*.emf|"
		+ "Формат BMP (*.bmp;*.dib;*.rle)|*.bmp;*.dib;*.rle|"
		+ "Формат JPEG (*.jpg;*.jpeg)|*.jpg;*.jpeg|"
		+ "Формат TIFF (*.tif)|*.tif|"
		+ "Формат GIF (*.gif)|*.gif|"
		+ "Формат PNG (*.png)|*.png|"
		+ "Формат ICON (*.ico)|*.ico|"
		+ "Формат метафайл (*.wmf;*.emf)|*.wmf;*.emf|";
	
	// Обработка выбора файла
	Если Диалог.Выбрать() Тогда
		
		// Загрузка выбранной картинки
		НоваяКартинка = Новый Картинка(Диалог.ПолноеИмяФайла, Ложь);
		
		// Установка картинки в элемент формы
		ЭтаФорма.Элементы.Картинка.Картинка = НоваяКартинка;
		
		// Сохранение картинки в реквизит объекта на сервере
		СохранитьКартинкуНаСервере(НоваяКартинка);
		
		// Установка признака модифицированности
		ЭтаФорма.Модифицированность = Истина;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура СохранитьКартинкуНаСервере(Знач НоваяКартинка)
	
	// Создание хранилища значений с картинкой и сохранение в реквизит объекта
	// Используем сжатие данных для экономии места в базе
	МаксимальнаяСтепеньСжатия = 9;
	Сжатие = Новый СжатиеДанных(МаксимальнаяСтепеньСжатия);
	Объект.Картинка = Новый ХранилищеЗначения(НоваяКартинка, Сжатие);
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	
	// Дополнительная проверка перед записью (при необходимости)
	// Здесь можно добавить проверку размера картинки и другие валидации
	
КонецПроцедуры

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	
	// Обновление картинки после записи (если требуется)
	Если ЗначениеЗаполнено(Объект.Картинка) Тогда
		
		КартинкаИзХранилища = Объект.Картинка.Получить();
		
		Если ТипЗнч(КартинкаИзХранилища) = Тип("Картинка") Тогда
			ЭтаФорма.Элементы.Картинка.Картинка = КартинкаИзХранилища;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры
